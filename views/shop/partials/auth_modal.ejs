<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  // Check if keys exist
  const apiKey = "<%= shopSettings && shopSettings.firebase_api_key ? shopSettings.firebase_api_key : '' %>";
  
  let auth, provider;

  if (apiKey) {
      const firebaseConfig = {
        apiKey: apiKey,
        authDomain: "<%= shopSettings.firebase_auth_domain %>",
        projectId: "<%= shopSettings.firebase_project_id %>",
        storageBucket: "<%= shopSettings.firebase_storage_bucket %>",
        messagingSenderId: "<%= shopSettings.firebase_messaging_sender_id %>",
        appId: "<%= shopSettings.firebase_app_id %>"
      };

      const app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      provider = new GoogleAuthProvider();
  } else {
      console.warn("Firebase API Key is missing in Admin Settings");
  }

  // Expose to Window for Alpine.js
  window.googleSignIn = async () => {
      if (!auth) throw new Error("Firebase not configured. Go to Admin > Settings > Login.");
      try {
          const result = await signInWithPopup(auth, provider);
          return result.user; 
      } catch (error) {
          console.error("Google Sign In Error:", error);
          throw error;
      }
  };
</script>

<div x-data="authModal()" 
     @open-login.window="openModal()"
     class="relative z-50" 
     x-show="isOpen" 
     style="display: none;">

    <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" 
         @click="closeModal()"></div>

    <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform transition-all">
            
            <button @click="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-black">
                <span class="material-icons-outlined">close</span>
            </button>

            <div x-show="step === 'init'" class="p-8 text-center">
                <h2 class="text-2xl font-serif font-bold mb-2">Welcome Back</h2>
                <p class="text-gray-500 text-sm mb-8">Sign in to access your account</p>

                <button @click="handleGoogleLogin()" 
                        class="w-full flex items-center justify-center gap-3 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-3 px-4 rounded-xl transition-all transform active:scale-95 shadow-sm">
                    <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-6 h-6" alt="Google">
                    <span>Continue with Google</span>
                </button>
            </div>

            <div x-show="step === 'phone'" class="p-8">
                <h2 class="text-xl font-bold mb-2">One Last Step</h2>
                <p class="text-gray-500 text-sm mb-6">We need your phone number to link or create your account.</p>
                
                <form @submit.prevent="verifyPhone">
                    <div class="mb-4">
                        <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Mobile Number</label>
                        <input type="tel" x-model="phone" placeholder="017XXXXXXXX" maxlength="11"
                               class="w-full border border-gray-300 rounded-lg px-4 py-3 outline-none focus:border-black font-mono tracking-widest">
                    </div>
                    <button type="submit" :disabled="loading"
                            class="w-full bg-black text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition disabled:opacity-50">
                        <span x-show="!loading">Verify Number</span>
                        <span x-show="loading">Checking...</span>
                    </button>
                </form>
            </div>

            <div x-show="step === 'link'" class="p-8 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-icons-outlined text-3xl text-green-600">person</span>
                </div>
                <h2 class="text-xl font-bold mb-2">Account Found!</h2>
                <p class="text-gray-500 text-sm mb-6">
                    Is this you?<br>
                    <strong class="text-black text-lg" x-text="foundUser.name"></strong><br>
                    <span x-text="foundUser.address"></span>
                </p>
                
                <button @click="confirmLink()" 
                        class="w-full bg-black text-white font-bold py-3 rounded-xl mb-3 hover:bg-gray-800 transition">
                    Yes, Link my Google Account
                </button>
                <button @click="step = 'phone'" class="text-gray-500 text-sm hover:underline">
                    No, use a different number
                </button>
            </div>

            <div x-show="step === 'conflict'" class="p-8 text-center" x-cloak>
                <div class="w-16 h-16 bg-yellow-50 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="material-icons-outlined text-3xl">lock</span>
                </div>
                
                <h2 class="text-xl font-bold mb-2">Account Exists</h2>
                <p class="text-gray-500 text-sm mb-6">
                    The phone number <strong x-text="phone"></strong> is already linked to another email address:
                </p>

                <div class="bg-gray-100 py-3 px-4 rounded-lg mb-6 border border-gray-200">
                    <p class="font-mono font-bold text-lg text-gray-800 tracking-wider" x-text="maskedEmail"></p>
                </div>

                <p class="text-xs text-gray-400 mb-6">
                    Please log out of Google and sign in with the email above to access your account.
                </p>

                <button @click="closeModal()" 
                        class="w-full bg-black text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition">
                    Okay, understood
                </button>
            </div>

            <div x-show="processing" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center z-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-black mb-4"></div>
                <p class="text-sm font-bold tracking-widest animate-pulse">LOGGING IN...</p>
            </div>

        </div>
    </div>
</div>

<script>
function authModal() {
    return {
        isOpen: false,
        step: 'init', 
        processing: false,
        loading: false,
        googleUser: null,
        phone: '',
        maskedEmail: '',
        foundUser: {},

        openModal() { this.isOpen = true; this.step = 'init'; },
        closeModal() { this.isOpen = false; },

        // Helper to get CSRF Token safely
        getToken() {
            const meta = document.querySelector('meta[name="csrf-token"]');
            return meta ? meta.getAttribute('content') : '';
        },

        async handleGoogleLogin() {
            try {
                this.processing = true;
                const user = await window.googleSignIn();
                this.googleUser = user;

                const res = await fetch('/customer/google-login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'CSRF-Token': this.getToken() 
                    },
                    body: JSON.stringify({
                        email: user.email,
                        uid: user.uid,
                        photoURL: user.photoURL
                    })
                });
                
                if(!res.ok) throw new Error("Server Error: " + res.status);
                const data = await res.json();

                if (data.status === 'success') {
                    window.location.reload();
                } else if (data.status === 'needs_phone') {
                    this.step = 'phone';
                    this.processing = false;
                }
            } catch (err) {
                console.error(err);
                this.processing = false;
                alert("Login Error: " + (err.code || err.message));
            }
        },

        async verifyPhone() {
            if (!/^01\d{9}$/.test(this.phone)) {
                alert("Please enter a valid 11-digit number starting with 01");
                return;
            }
            this.loading = true;
            try {
                const res = await fetch('/customer/verify-phone', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'CSRF-Token': this.getToken() 
                    },
                    body: JSON.stringify({ phone: this.phone })
                });
                const data = await res.json();
                this.loading = false;

                if (data.status === 'conflict') {
                    // [NEW] Handle Conflict
                    this.maskedEmail = data.masked_email;
                    this.step = 'conflict';
                } 
                else if (data.status === 'found') {
                    this.foundUser = data.customer;
                    this.step = 'link';
                } 
                else {
                    this.createNewAccount();
                }
            } catch(err) {
                this.loading = false;
                alert("Error verifying phone: " + err.message);
            }
        },

        async confirmLink() {
            this.processing = true;
            await fetch('/customer/link', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': this.getToken() },
                body: JSON.stringify({
                    email: this.googleUser.email,
                    uid: this.googleUser.uid,
                    photoURL: this.googleUser.photoURL,
                    phone: this.phone
                })
            }).then(() => window.location.reload());
        },

        async createNewAccount() {
            this.processing = true;
            await fetch('/customer/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'CSRF-Token': this.getToken() },
                body: JSON.stringify({
                    email: this.googleUser.email,
                    uid: this.googleUser.uid,
                    photoURL: this.googleUser.photoURL,
                    phone: this.phone,
                    name: this.googleUser.displayName
                })
            }).then(() => window.location.reload());
        }
    }
}
</script>