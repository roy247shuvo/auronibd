<style>
    /* 1. THE DIP TO BLACK EFFECT */
    /* We ensure the slide fades in from black and fades out to black */
    .slide-enter {
        animation: fadeIn 1.5s ease-in-out forwards;
    }
    .slide-leave {
        animation: fadeOut 1.5s ease-in-out forwards;
    }

    @keyframes fadeIn {
        0% { opacity: 0; }
        100% { opacity: 1; }
    }
    @keyframes fadeOut {
        0% { opacity: 1; }
        100% { opacity: 0; }
    }

    /* 2. ALTERNATING ZOOM ANIMATIONS */
    /* These run continuously while the slide is visible */
    @keyframes zoomInEffect {
        0% { transform: scale(1); }
        100% { transform: scale(1.15); }
    }
    @keyframes zoomOutEffect {
        0% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    .animate-zoom-in {
        animation: zoomInEffect 7s ease-out forwards;
    }
    .animate-zoom-out {
        animation: zoomOutEffect 7s ease-out forwards;
    }

    /* 3. TEXT SLIDE ANIMATIONS */
    @keyframes slideFromLeft {
        0% { transform: translateX(-50px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideFromRight {
        0% { transform: translateX(50px); opacity: 0; }
        100% { transform: translateX(0); opacity: 1; }
    }

    .text-slide-left {
        animation: slideFromLeft 1.5s ease-out 0.5s forwards; /* 0.5s delay */
    }
    .text-slide-right {
        animation: slideFromRight 1.5s ease-out 0.5s forwards; /* 0.5s delay */
    }
</style>

<section class="relative h-screen w-full overflow-hidden bg-black group" 
         x-data="heroSlider()"
         x-init="initSlider()"
         @mouseenter="stopTimer()" 
         @mouseleave="startTimer()">

    <% if(lightboxes.length > 0) { %>
        <% lightboxes.forEach((l, index) => { 
            let displayUrl = l.image_url;
            let isEven = index % 2 === 0; 
            
            // --- CROP LOGIC ---
            if(l.media_type === 'image' && l.crop_data) {
                try {
                    const c = JSON.parse(l.crop_data);
                    const parts = l.image_url.split('/upload/');
                    if(parts.length === 2) {
                        displayUrl = `${parts[0]}/upload/x_${Math.round(c.x)},y_${Math.round(c.y)},w_${Math.round(c.width)},h_${Math.round(c.height)},c_crop/${parts[1]}`;
                    }
                } catch(e) {}
            }
        %>

        <div class="absolute inset-0 w-full h-full"
             x-show="activeSlide === <%= index %>"
             x-transition:enter="slide-enter"
             x-transition:leave="slide-leave"
             style="display: none;">

            <div class="absolute inset-0 overflow-hidden">
                <% if(l.media_type === 'video') { %>
                    <video src="<%= l.image_url %>" class="w-full h-full object-cover opacity-90" autoplay muted loop playsinline></video>
                <% } else { %>
                    <img src="<%= displayUrl %>" 
                         class="w-full h-full object-cover opacity-80 <%= isEven ? 'animate-zoom-in' : 'animate-zoom-out' %>">
                <% } %>
                <div class="absolute inset-0 bg-black/30"></div>
            </div>
            
            <div class="absolute inset-0 flex flex-col justify-center items-center text-center text-white p-6 z-10 pointer-events-none">
                
                <h1 class="font-serif italic tracking-tight text-5xl md:text-7xl lg:text-9xl mb-8 opacity-0 <%= isEven ? 'text-slide-left' : 'text-slide-right' %>">
                    <%= l.title %>
                </h1>
                
                <a href="<%= l.link %>" 
                   class="pointer-events-auto px-10 py-3 border border-white hover:bg-white hover:text-black transition-all duration-300 text-xs font-bold uppercase tracking-[0.2em] opacity-0 animate-[fadeIn_1s_ease-out_1s_forwards]">
                    <%= l.button_text %>
                </a>
            </div>
        </div>
        <% }) %>

        <% if(lightboxes.length > 1) { %>
            <button @click="prev()" class="absolute left-4 top-1/2 -translate-y-1/2 z-20 text-white/30 hover:text-white hover:scale-110 transition-all duration-300 p-4 rounded-full hover:bg-black/20">
                <span class="material-icons-outlined text-5xl md:text-6xl drop-shadow-md">chevron_left</span>
            </button>

            <button @click="next()" class="absolute right-4 top-1/2 -translate-y-1/2 z-20 text-white/30 hover:text-white hover:scale-110 transition-all duration-300 p-4 rounded-full hover:bg-black/20">
                <span class="material-icons-outlined text-5xl md:text-6xl drop-shadow-md">chevron_right</span>
            </button>

            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-20 flex space-x-3">
                <% lightboxes.forEach((_, idx) => { %>
                    <button @click="setSlide(<%= idx %>)" 
                            class="h-1 transition-all duration-500 rounded-full shadow-sm"
                            :class="activeSlide === <%= idx %> ? 'bg-white w-12' : 'bg-white/40 w-4 hover:bg-white'">
                    </button>
                <% }) %>
            </div>
        <% } %>

    <% } else { %>
        <div class="h-full w-full flex items-center justify-center bg-black text-white">
            <p class="font-serif italic text-xl text-gray-500">No active slides.</p>
        </div>
    <% } %>
</section>

<script>
    function heroSlider() {
        return {
            activeSlide: 0,
            total: <%= lightboxes.length %>,
            interval: 5000, // 5 Seconds
            timer: null,

            initSlider() {
                this.startTimer();
            },
            startTimer() {
                if (this.total > 1) {
                    this.stopTimer(); // Clear existing to prevent duplicates
                    this.timer = setInterval(() => {
                        this.next();
                    }, this.interval);
                }
            },
            stopTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
            },
            next() {
                this.activeSlide = (this.activeSlide + 1) % this.total;
            },
            prev() {
                this.activeSlide = (this.activeSlide === 0) ? this.total - 1 : this.activeSlide - 1;
            },
            setSlide(index) {
                this.activeSlide = index;
                this.stopTimer();
                this.startTimer(); // Restart timer after manual interaction
            }
        }
    }
</script>