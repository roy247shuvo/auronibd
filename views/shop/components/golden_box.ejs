<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<div id="goldenBoxContainer" class="fixed bottom-24 right-4 z-50 hidden" style="touch-action: manipulation;">
    <div class="relative cursor-pointer animate-bounce-slow group" onclick="openGiftModal()">
        <div class="text-6xl filter drop-shadow-2xl transition-transform duration-300 group-hover:scale-110">
            üéÅ
        </div>
        <div class="absolute -top-2 -right-2 text-2xl animate-ping text-yellow-500">‚ú®</div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-rose-400 rounded-full opacity-20 animate-pulse"></div>
    </div>
</div>

<div id="giftModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeGiftModal()"></div>
    
    <div class="relative w-full max-w-md bg-[#fff9f9] rounded-2xl shadow-2xl overflow-hidden transform transition-all border-2 border-rose-100">
        
        <button onclick="closeGiftModal()" class="absolute top-3 right-3 text-rose-300 hover:text-rose-500 transition z-10">
            <span class="material-icons-outlined text-2xl">close</span>
        </button>

        <div class="absolute top-0 left-0 w-24 h-24 opacity-10 pointer-events-none">
            <svg viewBox="0 0 100 100" fill="currentColor" class="text-rose-500"><path d="M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm0 90c-22.1 0-40-17.9-40-40s17.9-40 40-40 40 17.9 40 40-17.9 40-40 40z"/></svg>
        </div>

        <div class="p-8 text-center relative">
            
            <div id="giftStage1">
                <div class="text-6xl mb-4 animate-pulse">üå∏</div>
                <h2 class="font-serif text-2xl font-bold text-rose-950 mb-2">‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®!</h2>
                <p class="text-sm text-rose-800 mb-6 font-medium">‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßã‡¶™‡¶® ‡¶ó‡¶ø‡¶´‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®! ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø‡¶§‡ßá ‡¶Ö‡¶Ç‡¶∂ ‡¶®‡¶ø‡¶§‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ì ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                
                <form onsubmit="submitGiftForm(event)" class="space-y-4 text-left">
                    <div>
                        <label class="block text-xs font-bold uppercase text-rose-900/60 mb-1 ml-1">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="giftName" required 
                            class="w-full border border-rose-200 bg-white p-3 rounded-lg focus:ring-2 focus:ring-rose-400 focus:border-rose-400 outline-none text-gray-800 placeholder-rose-200"
                            placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-rose-900/60 mb-1 ml-1">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                        <input type="tel" id="giftPhone" required 
                            class="w-full border border-rose-200 bg-white p-3 rounded-lg focus:ring-2 focus:ring-rose-400 focus:border-rose-400 outline-none text-gray-800 placeholder-rose-200"
                            placeholder="017..." pattern="[0-9]{11}">
                    </div>
                    <button type="submit" class="w-full bg-rose-500 text-white py-3.5 rounded-lg font-bold shadow-lg hover:bg-rose-600 active:scale-95 transition-all duration-200">
                        ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶® 
                    </button>
                </form>
            </div>

            <div id="giftStage2" class="hidden">
                <div class="text-6xl mb-4 animate-bounce">üéâ</div>
                <h2 class="font-serif text-2xl font-bold text-rose-950 mb-2">‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!</h2>
                
                <div class="bg-green-50 border border-green-200 p-4 rounded-xl mb-6 shadow-sm">
                    <p class="text-gray-800 font-medium text-lg mb-1"><span id="finalName" class="text-rose-600 font-bold"></span>, ‡¶ó‡¶ø‡¶´‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡¶ü‡¶ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®!</p>
                    <p class="text-sm text-gray-600">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°: <span id="finalCode" class="font-bold font-mono bg-white px-2 py-0.5 rounded border border-green-200 text-green-700"></span></p>
                </div>

                <p class="text-xs text-gray-500 mb-6 leading-relaxed bg-rose-50 p-3 rounded-lg border border-rose-100">
                    ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶≤‡¶ü‡¶æ‡¶∞‡¶ø‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶¨‡¶ø‡¶ú‡¶Ø‡¶º‡ßÄ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡¶¨‡•§<br>
                    <strong>‡¶è‡¶á ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶ü‡¶ø‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶®‡¶ø‡¶®</strong> ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶¶‡¶ø‡¶®‡•§
                </p>

                <a href="https://www.facebook.com/auronishop" target="_blank" class="block w-full bg-[#1877F2] text-white py-3.5 rounded-lg font-bold shadow-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                    <span class="material-icons-outlined text-lg">facebook</span> ‡¶´‡ßá‡¶∏‡¶¨‡ßÅ‡¶ï ‡¶™‡ßá‡¶ú‡ßá ‡¶Ø‡¶æ‡¶®
                </a>
            </div>

        </div>
    </div>
</div>

<style>
    @keyframes bounce-slow {
        0%, 100% { transform: translateY(-5%); }
        50% { transform: translateY(5%); }
    }
    .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }
    /* ‡¶´‡¶®‡ßç‡¶ü ‡¶´‡¶ø‡¶ï‡ßç‡¶∏ */
    #giftModal { font-family: 'Jost', sans-serif; }
</style>

<script>
    // --- 1. GAME LOGIC ---
    document.addEventListener('DOMContentLoaded', async () => {
        const STORAGE_KEY = 'auroni_gift_hunt_v2'; // Key changed to reset old sessions
        const EXPIRY_TIME = 60 * 60 * 1000; // 1 Hour

        let huntData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const now = Date.now();

        // A. If no data or expired, fetch new target
        if (!huntData || (now - huntData.timestamp > EXPIRY_TIME)) {
            try {
                const res = await fetch('/api/gamification/target');
                const data = await res.json();
                
                huntData = {
                    target: data.target,
                    timestamp: now,
                    found: false
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(huntData));
            } catch (e) { console.error("Hunt Error", e); }
        }

        // B. Check if we are on the target page
        if (huntData && !huntData.found && huntData.target) {
            const currentPath = window.location.pathname;
            // Loose matching to handle trailing slashes
            if (currentPath === huntData.target || currentPath === huntData.target + '/') {
                // SHOW BOX with delay
                setTimeout(() => {
                    document.getElementById('goldenBoxContainer').classList.remove('hidden');
                }, 1500); 
            }
        }
    });

    // --- 2. MODAL LOGIC ---
    function generateCode() {
        return 'WIN-' + Math.floor(1000 + Math.random() * 9000);
    }

    function openGiftModal() {
        document.getElementById('giftModal').classList.remove('hidden');
        document.getElementById('goldenBoxContainer').classList.add('hidden'); 
    }

    function closeGiftModal() {
        document.getElementById('giftModal').classList.add('hidden');
    }

    // --- 3. SUBMISSION LOGIC ---
    async function submitGiftForm(e) {
        e.preventDefault();
        const name = document.getElementById('giftName').value;
        const phone = document.getElementById('giftPhone').value;
        const code = generateCode(); // Generate the code upon submission

        // CSRF Token ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π (Layout ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá)
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        try {
            const res = await fetch('/api/gamification/submit', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'CSRF-Token': csrfToken // [FIX] Security Token ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá
                },
                body: JSON.stringify({ name, phone, code })
            });

            const result = await res.json();

            if (result.success) {
                // ‡¶Ü‡¶™‡¶°‡ßá‡¶ü UI
                document.getElementById('finalName').innerText = name;
                document.getElementById('finalCode').innerText = code;
                document.getElementById('giftStage1').classList.add('hidden');
                document.getElementById('giftStage2').classList.remove('hidden');

                // ‡¶ï‡¶®‡¶´‡ßá‡¶ü‡¶ø ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® (Celebration)
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 },
                    colors: ['#f43f5e', '#fb7185', '#ffe4e6'] // Pinkish confetti
                });

                // ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú‡ßá ‡¶´‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï ‡¶ï‡¶∞‡¶æ
                const STORAGE_KEY = 'auroni_gift_hunt_v2';
                let huntData = JSON.parse(localStorage.getItem(STORAGE_KEY));
                if(huntData) {
                    huntData.found = true;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(huntData));
                }
            } else {
                alert(result.message || "Error submitting.");
            }
        } catch (error) {
            console.error(error);
            alert("‡¶ï‡ßã‡¶•‡¶æ‡¶ì ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá, ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
        }
    }
</script>