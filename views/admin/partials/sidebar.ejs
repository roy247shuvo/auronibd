<aside id="adminSidebar" class="w-64 bg-white h-screen fixed left-0 top-0 border-r border-gray-100 z-50 flex flex-col shadow-[4px_0_24px_rgba(0,0,0,0.02)] overflow-y-auto pb-10 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out">
    
    <div class="h-20 flex items-center justify-between px-6 border-b border-gray-50 flex-shrink-0">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center text-white font-bold shadow-red-200 shadow-lg">
                NB
            </div>
            <span class="ml-3 font-bold text-lg text-gray-900 tracking-tight">Niche Boutique</span>
        </div>
        
        <button onclick="toggleMobileMenu()" class="md:hidden text-gray-500 hover:text-red-500">
            <span class="material-icons-outlined">close</span>
        </button>
    </div>

    <nav class="flex-1 py-6 px-3 space-y-1">

        <a href="/admin/dashboard" class="flex items-center px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-red-50 hover:text-red-600 group transition-all">
            <span class="material-icons-outlined text-[20px] mr-3 text-gray-400 group-hover:text-red-500">home</span>
            Home
        </a>

        <% if (can('pos_terminal', 'read') || can('pos_history', 'read') || can('pos_setting', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-pos')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">point_of_sale</span>
                    POS
                </div>
                <span id="icon-menu-pos" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-pos" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('pos_terminal', 'read')) { %>
                    <a href="/admin/pos" class="block py-2 text-sm text-gray-500 hover:text-red-600">POS Terminal</a>
                <% } %>
                <% if (can('pos_history', 'read')) { %>
                    <a href="/admin/pos/history" class="block py-2 text-sm text-gray-500 hover:text-red-600">Sale History</a>
                <% } %>
                <% if (can('pos_setting', 'read')) { %>
                    <a href="/admin/pos/pos-setting" class="block py-2 text-sm text-gray-500 hover:text-red-600">POS Setting</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('orders_web', 'read') || can('orders_return', 'read') || can('orders_label', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-orders')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">shopping_bag</span>
                    Orders
                </div>
                <span id="icon-menu-orders" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-orders" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('orders_web', 'read')) { %>
                    <a href="/admin/orders/web-orders" class="block py-2 text-sm text-gray-500 hover:text-red-600">Web Orders</a>
                <% } %>
                <% if (can('orders_return', 'read')) { %>
                    <a href="/admin/orders/returns" class="block py-2 text-sm text-gray-500 hover:text-red-600">Partial Returns</a>
                <% } %>
                <% if (can('orders_label', 'read')) { %>
                    <a href="/admin/orders/label-settings" class="block py-2 text-sm text-gray-500 hover:text-red-600">Label Settings</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('prod_inventory', 'read') || can('prod_collections', 'read') || can('prod_po', 'read') || can('prod_settings', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-products')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">inventory_2</span>
                    Products
                </div>
                <span id="icon-menu-products" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-products" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('prod_inventory', 'read')) { %>
                    <a href="/admin/products" class="block py-2 text-sm text-gray-500 hover:text-red-600">Inventory</a>
                <% } %>
                <% if (can('prod_collections', 'read')) { %>
                    <a href="/admin/collections" class="block py-2 text-sm text-gray-500 hover:text-red-600">Collections</a>
                <% } %>
                <% if (can('prod_po', 'read')) { %>
                    <a href="/admin/purchase-orders" class="block py-2 text-sm text-gray-500 hover:text-red-600">Purchase Orders</a>
                <% } %>
                <% if (can('prod_settings', 'read')) { %>
                    <a href="/admin/products/settings" class="block py-2 text-sm text-gray-500 hover:text-red-600">Products Setting</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('cust_list', 'read') || can('vend_list', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-customers')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">people</span>
                    Customers & Vendors
                </div>
                <span id="icon-menu-customers" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-customers" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('cust_list', 'read')) { %>
                    <a href="/admin/customers" class="block py-2 text-sm text-gray-500 hover:text-red-600">Customers</a>
                <% } %>
                <% if (can('vend_list', 'read')) { %>
                    <a href="/admin/vendors" class="block py-2 text-sm text-gray-500 hover:text-red-600">Vendors</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('camp_sms', 'read') || can('camp_meta', 'read') || can('camp_subs', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-campaigns')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">campaign</span>
                    Campaigns
                </div>
                <span id="icon-menu-campaigns" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-campaigns" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('camp_sms', 'read')) { %>
                    <a href="/admin/campaigns/sms" class="block py-2 text-sm text-gray-500 hover:text-red-600">SMS Campaigns</a>
                <% } %>
                <% if (can('camp_meta', 'read')) { %>
                    <a href="/admin/campaigns/meta" class="block py-2 text-sm text-gray-500 hover:text-red-600">Meta Campaigns</a>
                <% } %>
                <% if (can('camp_subs', 'read')) { %>
                    <a href="/admin/campaigns/subscribers" class="block py-2 text-sm text-gray-500 hover:text-red-600">Subscribers</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('disc_coupons', 'read') || can('disc_credits', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-discounts')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">percent</span>
                    Discounts
                </div>
                <span id="icon-menu-discounts" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-discounts" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('disc_coupons', 'read')) { %>
                    <a href="/admin/discounts/coupons" class="block py-2 text-sm text-gray-500 hover:text-red-600">Coupons</a>
                <% } %>
                <% if (can('disc_credits', 'read')) { %>
                    <a href="/admin/discounts/credits" class="block py-2 text-sm text-gray-500 hover:text-red-600">Store Credits</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('web_elements', 'read') || can('web_checkout', 'read') || can('web_notif', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-website')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">language</span>
                    Website
                </div>
                <span id="icon-menu-website" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-website" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('web_elements', 'read')) { %>
                    <a href="/admin/website/elements" class="block py-2 text-sm text-gray-500 hover:text-red-600">Elements</a>
                <% } %>
                <% if (can('web_checkout', 'read')) { %>
                    <a href="/admin/website/checkout-options" class="block py-2 text-sm text-gray-500 hover:text-red-600">Checkout Options</a>
                <% } %>
                <% if (can('web_notif', 'read')) { %>
                    <a href="/admin/website/notifications" class="block py-2 text-sm text-gray-500 hover:text-red-600">Confirmation SMS/Email</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('acc_overview', 'read') || can('acc_transfers', 'read') || can('acc_sales', 'read') || can('acc_expenses', 'read') || can('acc_reports', 'read') || can('acc_settings', 'read')) { %>
        <div class="menu-item">
            <button onclick="toggleMenu('menu-accounts')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">account_balance</span>
                    Accounts
                </div>
                <span id="icon-menu-accounts" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-accounts" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('acc_overview', 'read')) { %>
                    <a href="/admin/accounts/overview" class="block py-2 text-sm text-gray-500 hover:text-red-600">Overview</a>
                <% } %>
                <% if (can('acc_transfers', 'read')) { %>
                    <a href="/admin/accounts/transfers" class="block py-2 text-sm text-gray-500 hover:text-red-600">View & Transfers</a>
                <% } %>
                <% if (can('acc_sales', 'read')) { %>
                    <a href="/admin/accounts/sales" class="block py-2 text-sm text-gray-500 hover:text-red-600">Sales Data</a>
                <% } %>
                
                <a href="/admin/accounts/courier-data" class="block py-2 text-sm text-gray-500 hover:text-red-600">Courier Data</a>
                <a href="/admin/accounts/marketing" class="block py-2 text-sm text-gray-500 hover:text-red-600">Marketing Data</a>
                
                <% if (can('acc_expenses', 'read')) { %>
                    <a href="/admin/accounts/expenses" class="block py-2 text-sm text-gray-500 hover:text-red-600">Expenses</a>
                <% } %>
                <% if (can('acc_reports', 'read')) { %>
                    <a href="/admin/accounts/pl-report" class="block py-2 text-sm text-gray-500 hover:text-red-600">P/L Statement</a>
                    <a href="/admin/accounts/balance-sheet" class="block py-2 text-sm text-gray-500 hover:text-red-600">Financial Health</a>
                <% } %>
                <% if (can('acc_settings', 'read')) { %>
                    <a href="/admin/accounts/settings" class="block py-2 text-sm text-gray-500 hover:text-red-600">Settings (Cash/Bank)</a>
                <% } %>
            </div>
        </div>
        <% } %>

        <% if (can('set_general', 'read') || can('set_store', 'read') || can('set_users', 'read') || can('set_smtp', 'read')) { %>
        <div class="menu-item border-t border-gray-100 mt-4 pt-4">
            <button onclick="toggleMenu('menu-settings')" class="w-full flex items-center justify-between px-3 py-2.5 text-sm font-medium text-gray-600 rounded-lg hover:bg-gray-50 hover:text-gray-900 transition-all">
                <div class="flex items-center">
                    <span class="material-icons-outlined text-[20px] mr-3 text-gray-400">settings</span>
                    Settings
                </div>
                <span id="icon-menu-settings" class="material-icons-outlined text-[16px] text-gray-400 transition-transform">add</span>
            </button>
            <div id="menu-settings" class="hidden pl-10 pr-2 py-1 space-y-1">
                <% if (can('set_general', 'read')) { %>
                    <a href="/admin/settings/general" class="block py-2 text-sm text-gray-500 hover:text-red-600">General & Courier</a>
                <% } %>
                <% if (can('set_store', 'read')) { %>
                    <a href="/admin/settings/store" class="block py-2 text-sm text-gray-500 hover:text-red-600">Store Details</a>
                <% } %>
                <% if (can('set_users', 'read')) { %>
                    <a href="/admin/settings/users" class="block py-2 text-sm text-gray-500 hover:text-red-600">Users & Roles</a>
                <% } %>
                <% if (can('set_smtp', 'read')) { %>
                    <a href="/admin/settings/smtp" class="block py-2 text-sm text-gray-500 hover:text-red-600">SMTP & SMS</a>
                    <a href="/admin/settings/analytics" class="block py-2 text-sm text-gray-500 hover:text-red-600">Meta Pixel & Analytics</a>
                <% } %>
            </div>
        </div>
        <% } %>

    </nav>
</aside>

<script>
    // 1. Manual Toggle Function
    function toggleMenu(menuId) {
        const menu = document.getElementById(menuId);
        menu.classList.toggle('hidden');
        
        const icon = document.getElementById('icon-' + menuId);
        if (menu.classList.contains('hidden')) {
            icon.innerText = 'add';
        } else {
            icon.innerText = 'remove';
        }
    }

    // 2. Auto-Expand & Highlight Active Link on Load
    document.addEventListener("DOMContentLoaded", () => {
        const currentPath = window.location.pathname;
        const links = document.querySelectorAll('aside nav a');

        links.forEach(link => {
            const href = link.getAttribute('href');
            
            // Check if href matches current path
            // FIX: Added "&& href !== '/admin/pos'" to prevent POS Terminal from lighting up when on History page
            if (href && (currentPath === href || (currentPath.startsWith(href) && href !== '/admin/dashboard' && href !== '/admin/pos'))) {
                
                // A. Highlight the Link
                link.classList.add('bg-red-50', 'text-red-600');
                link.classList.remove('text-gray-600', 'text-gray-500'); // Remove default gray style
                
                // B. Expand Parent Menu (if it exists)
                const parentMenu = link.closest('div[id^="menu-"]');
                if (parentMenu) {
                    parentMenu.classList.remove('hidden');
                    
                    // Update the +/- Icon
                    const iconId = 'icon-' + parentMenu.id;
                    const icon = document.getElementById(iconId);
                    if(icon) icon.innerText = 'remove';
                }
            }
        });
    });
</script>