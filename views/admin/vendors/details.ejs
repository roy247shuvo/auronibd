<div class="max-w-6xl mx-auto">
    <% if (!can('purchase_orders', 'write')) { %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="material-icons-outlined text-yellow-400">lock</span>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <span class="font-bold">View Only Mode:</span> You cannot receive orders or make payments.
                </p>
            </div>
        </div>
    </div>
    <% } %>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 col-span-1 md:col-span-1">
            <h1 class="text-xl font-bold text-gray-900 mb-1"><%= vendor.name %></h1>
            <p class="text-sm text-gray-500 mb-4"><i class="fas fa-phone-alt text-xs mr-2"></i> <%= vendor.phone %></p>
            <p class="text-xs text-gray-400 bg-gray-50 p-3 rounded-lg border border-gray-100">
                <%= vendor.address || 'No address provided' %>
            </p>
            <div class="mt-6 flex gap-2">
                <a href="/admin/vendors" class="text-xs font-bold text-gray-500 hover:text-black border-b border-gray-300 pb-0.5">Back to List</a>
            </div>
        </div>

        <div class="bg-gray-900 text-white p-6 rounded-xl shadow-lg col-span-1 md:col-span-2 flex items-center justify-between">
            <div>
                <p class="text-xs text-gray-400 uppercase font-bold tracking-widest mb-1">Account Balance</p>
                <div class="text-3xl font-mono font-bold">
                    <% if(vendor.balance < 0) { %>
                        <span class="text-red-400">Due: <%= Math.abs(vendor.balance) %></span>
                    <% } else if(vendor.balance > 0) { %>
                        <span class="text-green-400">Adv: +<%= vendor.balance %></span>
                    <% } else { %>
                        <span class="text-gray-500">Settled</span>
                    <% } %>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">
                    Negative means we owe the vendor. Positive means we overpaid.
                </p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400 uppercase font-bold mb-1">Total Orders</p>
                <p class="text-4xl font-bold"><%= vendor.po_count %></p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
            <h3 class="font-bold text-gray-800">Recent Purchase Orders</h3>
            <a href="/admin/vendors/history/<%= vendor.id %>" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1">
                View All History <i class="fas fa-arrow-right"></i>
            </a>
        </div>

        <table class="w-full text-left border-collapse">
            <thead class="bg-white text-xs uppercase text-gray-500 font-bold border-b border-gray-100">
                <tr>
                    <th class="px-6 py-4">PO Number</th>
                    <th class="px-6 py-4 text-center">Items</th>
                    <th class="px-6 py-4 text-right">Total</th>
                    <th class="px-6 py-4 text-right">Paid</th>
                    <th class="px-6 py-4 text-right">Due</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-center">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50 text-sm">
                <% recentPOs.forEach(po => { 
                   const due = po.total_amount - po.paid_amount;
                %>
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <a href="#" onclick="openViewPO('<%= po.id %>'); return false;" class="font-bold text-blue-600 hover:underline">
                            <%= po.po_number %>
                        </a>
                        <p class="text-[10px] text-gray-400"><%= new Date(po.created_at).toLocaleDateString() %></p>
                    </td>
                    <td class="px-6 py-4 text-center font-bold text-gray-700">
                        <%= po.total_qty %>
                    </td>
                    <td class="px-6 py-4 text-right font-mono">TK. <%= po.total_amount %></td>
                    <td class="px-6 py-4 text-right font-mono text-gray-500">TK. <%= po.paid_amount %></td>
                    <td class="px-6 py-4 text-right font-mono font-bold <%= due > 0 ? 'text-red-600' : 'text-green-600' %>">
                        <%= due.toFixed(2) %>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <% if(po.status === 'received') { %>
                            <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-[10px] font-bold uppercase">Received</span>
                        <% } else { %>
                            <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded text-[10px] font-bold uppercase">Pending</span>
                        <% } %>
                    </td>
                    <td class="px-6 py-4 text-center flex justify-center gap-2">
                        <% if(po.status === 'pending' && can('purchase_orders', 'write')) { %>
                            <button onclick="receivePO('<%= po.id %>')" class="w-7 h-7 rounded hover:bg-blue-100 text-blue-600 flex items-center justify-center transition" title="Mark as Received">
                                <span class="material-icons-outlined text-sm">inventory</span>
                            </button>
                        <% } %>

                        <% if(due > 0 && can('purchase_orders', 'write')) { %>
                            <button onclick="openPaymentModal('existing', { id: <%= po.id %>, total: <%= po.total_amount %>, paid: <%= po.paid_amount %> })" 
                                    class="w-7 h-7 rounded hover:bg-green-100 text-green-600 flex items-center justify-center transition" title="Add Payment">
                                <span class="material-icons-outlined text-sm">payments</span>
                            </button>
                        <% } %>
                    </td>
                </tr>
                <% }) %>
                <% if(recentPOs.length === 0) { %>
                    <tr><td colspan="7" class="text-center py-8 text-gray-400">No orders found.</td></tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<%- include('../orders/modals/payment_modal') %>
<%- include('../orders/modals/view_po_details') %>

<script>
    async function receivePO(id) {
         if(!confirm('Are you sure you received these items? This will add stock to inventory batches.')) return;
         try {
            const res = await fetch(`/admin/purchase-orders/receive/${id}`, { 
                method: 'POST',
                headers: { 'CSRF-Token': '<%= csrfToken %>' }
            });
            const data = await res.json();
            if(data.success) location.reload();
            else alert(data.error);
        } catch(err) { alert('Error receiving PO'); }
    }
</script>