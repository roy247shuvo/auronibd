<% if (!can('acc_sales', 'write')) { %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0"><span class="material-icons-outlined text-yellow-400">lock</span></div>
            <div class="ml-3"><p class="text-sm text-yellow-700"><span class="font-bold">View Only:</span> No write permissions.</p></div>
        </div>
    </div>
<% } %>

<div class="flex flex-col md:flex-row justify-between items-end mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Courier Settlements</h1>
        <p class="text-sm text-gray-500 mt-1">Manage payouts from Steadfast Courier.</p>
    </div>
    
    <button onclick="loadPendingBatches()" class="text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
        <span class="material-icons-outlined text-[18px]">refresh</span>
        Check for New Payments
    </button>
</div>

<div id="pendingSection" class="mb-10">
    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
        Pending Actions (Unclaimed Payouts)
    </h3>
    
    <div id="pendingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full py-8 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
            <span class="material-icons-outlined text-2xl animate-spin mb-2">sync</span>
            <p>Checking Steadfast...</p>
        </div>
    </div>
</div>

<div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
        <h2 class="text-lg font-bold text-gray-800">Settlement History</h2>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="text-xs text-gray-400">Total Collected</p>
                <p class="font-bold text-gray-900">৳<%= stats.totalReceived.toLocaleString() %></p>
            </div>
            <div class="w-px h-8 bg-gray-200"></div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Net Income</p>
                <p class="font-bold text-blue-600">৳<%= (stats.totalReceived - stats.totalDeliveryCost - stats.totalCodFees).toLocaleString() %></p>
            </div>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider font-bold border-b border-gray-100">
                    <th class="px-6 py-4">Settled Date</th>
                    <th class="px-6 py-4">Order Info</th>
                    <th class="px-6 py-4 text-right">Breakdown</th>
                    <th class="px-6 py-4 text-right">Net Payout</th>
                    <th class="px-6 py-4 text-center">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                <% orders.forEach(order => { 
                    const cod = parseFloat(order.cod_received || 0);
                    const charge = parseFloat(order.courier_delivery_charge || 0);
                    const codFee = cod * 0.01;
                    const netOrder = cod - charge - codFee;
                %>
                <tr class="hover:bg-gray-50 transition-colors group">
                    <td class="px-6 py-4">
                        <div class="text-sm font-bold text-gray-900">
                            <%= new Date(order.settled_at).toLocaleDateString('en-GB') %>
                        </div>
                        <div class="text-xs text-gray-400 font-mono mt-0.5">
                            <%= new Date(order.settled_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <a href="/admin/orders/web-orders?q=<%= order.order_number %>" class="text-sm font-bold text-blue-600 hover:underline font-mono">
                            <%= order.order_number %>
                        </a>
                        <div class="text-xs text-gray-500 mt-0.5"><%= order.guest_name %></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] text-gray-400">COD: <b class="text-green-600">+<%= cod %></b></span>
                            <span class="text-[10px] text-gray-400">Fee: <b class="text-red-600">-<%= charge %></b></span>
                            <span class="text-[10px] text-gray-400">1%: <b class="text-orange-600">-<%= codFee.toFixed(2) %></b></span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-sm font-bold text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded">৳<%= netOrder.toFixed(2) %></span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">
                            <span class="material-icons-outlined text-[14px]">check</span> Settled
                        </span>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<div id="modalUpload" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm" onclick="closeModals()"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                <h3 class="font-bold text-gray-900">Step 1: Verify Batch</h3>
                <button onclick="closeModals()" class="text-gray-400 hover:text-red-500"><span class="material-icons-outlined">close</span></button>
            </div>
            
            <div class="p-6">
                <div class="text-center mb-6">
                    <div class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-icons-outlined text-3xl text-blue-600">upload_file</span>
                    </div>
                    <h4 class="font-bold text-lg" id="uploadBatchTitle">Batch #...</h4>
                    <p class="text-sm text-gray-500">Upload the Steadfast Excel file to retrieve delivery charges.</p>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Select Excel/CSV File</label>
                    <input type="file" id="verifyFile" accept=".csv, .xlsx" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors"/>
                    <p class="text-xs text-red-500 mt-2 hidden" id="uploadError"></p>
                </div>

                <button onclick="verifyBatch()" id="btnVerify" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition-all flex justify-center items-center gap-2">
                    Verify Data <span class="material-icons-outlined text-[18px]">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modalConfirm" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm"></div>
    <div class="fixed inset-0 z-10 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] flex flex-col">
            <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="material-icons-outlined text-green-600">verified</span>
                    <h3 class="font-bold text-green-900">Step 2: Confirm Deposit</h3>
                </div>
                <button onclick="closeModals()" class="text-gray-400 hover:text-red-500"><span class="material-icons-outlined">close</span></button>
            </div>

            <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4 bg-white border-b" id="confirmSummary">
                </div>

            <div class="flex-1 overflow-y-auto p-0">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">Invoice</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Collected (API)</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Delivery (Excel)</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Fee (1%)</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Net</th>
                        </tr>
                    </thead>
                    <tbody id="confirmTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>

            <div class="p-6 bg-gray-50 border-t flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="w-full md:w-1/2">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Deposit To Account</label>
                    <select id="finalBank" class="w-full border-gray-300 rounded-lg text-sm p-2.5">
                        <option value="" disabled selected>Select Bank / Mobile Wallet</option>
                        <% accounts.forEach(acc => { %>
                            <option value="<%= acc.id %>"><%= acc.bank_name %> - <%= acc.account_name %></option>
                        <% }); %>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                    <label class="block text-xs font-bold text-transparent mb-1">Action</label>
                    <button onclick="submitSettlement()" id="btnFinalSubmit" class="w-full md:w-auto bg-green-600 text-white px-8 py-2.5 rounded-lg font-bold hover:bg-green-700 shadow-lg flex items-center justify-center gap-2">
                        <span class="material-icons-outlined">payments</span> Confirm Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global State
    let currentBatchId = null;
    let verifiedData = null; // Stores verified data between steps

    document.addEventListener('DOMContentLoaded', loadPendingBatches);

    // 1. Load Batches
    async function loadPendingBatches() {
        const container = document.getElementById('pendingContainer');
        container.innerHTML = `<div class="col-span-full py-8 text-center text-gray-400 bg-gray-50 rounded-xl animate-pulse">Loading payouts...</div>`;

        try {
            const res = await fetch('/admin/accounts/settlements/pending');
            const data = await res.json();
            
            if(data.success && data.batches.length > 0) {
                container.innerHTML = '';
                data.batches.forEach(batch => {
                    container.innerHTML += `
                        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-all">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <span class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-2 py-1 rounded">PENDING</span>
                                    <h4 class="font-bold text-lg mt-2">${batch.id}</h4>
                                    <p class="text-xs text-gray-400">${new Date(batch.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-xs text-gray-400">Total COD</p>
                                    <p class="font-bold text-xl">৳${batch.cod_amount.toLocaleString()}</p>
                                </div>
                            </div>
                            <button onclick="openUploadModal('${batch.id}')" class="w-full py-2 rounded-lg bg-blue-50 text-blue-600 font-bold text-sm hover:bg-blue-100 flex justify-center items-center gap-2">
                                <span class="material-icons-outlined text-[18px]">upload_file</span> Confirm Payment
                            </button>
                        </div>
                    `;
                });
            } else {
                container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400 bg-gray-50 rounded-xl">No pending payouts found.</div>';
            }
        } catch(e) { 
            console.error(e); 
            container.innerHTML = `<div class="col-span-full text-red-500 text-center py-4">Failed to load batches.</div>`;
        }
    }

    // 2. Open Step 1 (Upload)
    function openUploadModal(batchId) {
        currentBatchId = batchId;
        document.getElementById('uploadBatchTitle').innerText = `Batch #${batchId}`;
        document.getElementById('verifyFile').value = ''; 
        document.getElementById('uploadError').classList.add('hidden');
        document.getElementById('modalUpload').classList.remove('hidden');
    }

    function closeModals() {
        document.getElementById('modalUpload').classList.add('hidden');
        document.getElementById('modalConfirm').classList.add('hidden');
        verifiedData = null;
    }

    // 3. Verify (Step 1 -> Step 2)
    async function verifyBatch() {
        const fileInput = document.getElementById('verifyFile');
        const btn = document.getElementById('btnVerify');
        const errorMsg = document.getElementById('uploadError');

        if(fileInput.files.length === 0) {
            errorMsg.innerText = "Please upload the file first.";
            errorMsg.classList.remove('hidden');
            return;
        }

        const fileName = fileInput.files[0].name;
        if(!fileName.includes(currentBatchId)) {
            errorMsg.innerText = `Filename must contain: ${currentBatchId}`;
            errorMsg.classList.remove('hidden');
            return;
        }

        btn.disabled = true;
        btn.innerHTML = 'Verifying...';

        const formData = new FormData();
        formData.append('batch_id', currentBatchId);
        formData.append('file', fileInput.files[0]);

        try {
            // [NOTE] Ensure you have a route: router.post('/settlement/verify', upload.single('file'), controller.verifyBatch);
            const res = await fetch('/admin/accounts/settlements/verify', {
                method: 'POST',
                headers: { 'CSRF-Token': '<%= csrfToken %>' },
                body: formData
            });
            const data = await res.json();

            if(data.success) {
                verifiedData = data;
                showConfirmModal(data);
            } else {
                errorMsg.innerText = data.message;
                errorMsg.classList.remove('hidden');
            }
        } catch(e) {
            alert("System Error: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Verify Data <span class="material-icons-outlined text-[18px]">arrow_forward</span>';
        }
    }

    // 4. Show Step 2 (Preview)
    function showConfirmModal(data) {
        document.getElementById('modalUpload').classList.add('hidden');
        document.getElementById('modalConfirm').classList.remove('hidden');

        // Populate Summary
        const s = data.summary;

        // [FIX] Steadfast Logic: Remove decimals from Total Deductions, then subtract from COD
        // Example: 929.8 -> 929. Net = COD - 929.
        const totalDeductions = Math.floor(s.total_delivery + s.total_fee);
        const calculatedNet = s.total_cod - totalDeductions;

        // Update global state so we deposit exactly what we calculate here
        verifiedData.summary.net_payout = calculatedNet;

        document.getElementById('confirmSummary').innerHTML = `
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Orders</p>
                <p class="font-bold text-lg">${s.total_orders}</p>
            </div>
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Total COD</p>
                <p class="font-bold text-lg text-gray-900">৳${s.total_cod.toLocaleString()}</p>
            </div>
            <div class="text-center p-3 bg-gray-50 rounded-lg">
                <p class="text-[10px] text-gray-400 font-bold uppercase">Delivery & Fees</p>
                <p class="font-bold text-lg text-red-600">-৳${totalDeductions.toLocaleString()}</p>
            </div>
            <div class="text-center p-3 bg-blue-50 border border-blue-100 rounded-lg">
                <p class="text-[10px] text-blue-600 font-bold uppercase">Net Deposit</p>
                <p class="font-bold text-xl text-blue-700">৳${calculatedNet.toLocaleString()}</p>
            </div>
        `;

        // Populate Table
        const tbody = document.getElementById('confirmTableBody');
        tbody.innerHTML = '';
        data.items.forEach(item => {
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-2 text-xs font-mono font-medium text-gray-900">${item.invoice}</td>
                    <td class="px-6 py-2 text-xs text-right text-green-600 font-bold">+${item.cod.toLocaleString()}</td>
                    <td class="px-6 py-2 text-xs text-right text-gray-600">${item.delivery}</td>
                    <td class="px-6 py-2 text-xs text-right text-orange-500">${item.fee.toFixed(2)}</td>
                    <td class="px-6 py-2 text-xs text-right font-bold text-gray-900">৳${item.net.toFixed(2)}</td>
                </tr>
            `;
        });
    }

    // 5. Final Submit
    async function submitSettlement() {
        const accountId = document.getElementById('finalBank').value;
        const btn = document.getElementById('btnFinalSubmit');

        if(!accountId) { alert("Please select a bank account."); return; }
        if(!confirm("Confirm deposit? This cannot be undone.")) return;

        btn.disabled = true;
        btn.innerHTML = 'Processing...';

        try {
            const res = await fetch('/admin/accounts/settlements/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>'
                },
                body: JSON.stringify({
                    batch_id: currentBatchId,
                    target_account_id: accountId,
                    verified_items: verifiedData.items, 
                    final_amount: verifiedData.summary.net_payout
                })
            });

            const result = await res.json();
            if(result.success) {
                alert("Success! Deposit Confirmed.");
                window.location.reload();
            } else {
                alert("Error: " + result.message);
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-outlined">payments</span> Confirm Deposit';
            }
        } catch(e) {
            alert("Error: " + e.message);
            btn.disabled = false;
        }
    }
</script>