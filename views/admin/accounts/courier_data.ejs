<% if (!can('acc_sales', 'write')) { %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0"><span class="material-icons-outlined text-yellow-400">lock</span></div>
            <div class="ml-3"><p class="text-sm text-yellow-700"><span class="font-bold">View Only:</span> No write permissions.</p></div>
        </div>
    </div>
<% } %>

<div class="flex flex-col md:flex-row justify-between items-end mb-8">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Courier Settlements</h1>
        <p class="text-sm text-gray-500 mt-1">Manage payouts from Steadfast Courier.</p>
    </div>
    
    <button onclick="loadPendingBatches()" class="text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
        <span class="material-icons-outlined text-[18px]">refresh</span>
        Check for New Payments
    </button>
</div>

<div id="pendingSection" class="mb-10">
    <h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center gap-2">
        <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
        Pending Actions (Unclaimed Payouts)
    </h3>
    
    <div id="pendingContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="col-span-full py-8 text-center text-gray-400 bg-gray-50 rounded-xl border border-dashed border-gray-200">
            <span class="material-icons-outlined text-2xl animate-spin mb-2">sync</span>
            <p>Checking Steadfast...</p>
        </div>
    </div>
</div>

<div class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
        <h2 class="text-lg font-bold text-gray-800">Settlement History</h2>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <p class="text-xs text-gray-400">Total Collected</p>
                <p class="font-bold text-gray-900">৳<%= stats.totalReceived.toLocaleString() %></p>
            </div>
            <div class="w-px h-8 bg-gray-200"></div>
            <div class="text-right">
                <p class="text-xs text-gray-400">Net Income</p>
                <p class="font-bold text-blue-600">৳<%= (stats.totalReceived - stats.totalDeliveryCost - stats.totalCodFees).toLocaleString() %></p>
            </div>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider font-bold border-b border-gray-100">
                    <th class="px-6 py-4">Settled Date</th>
                    <th class="px-6 py-4">Order Info</th>
                    <th class="px-6 py-4 text-right">Breakdown</th>
                    <th class="px-6 py-4 text-right">Net Payout</th>
                    <th class="px-6 py-4 text-center">Status</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                <% orders.forEach(order => { 
                    const cod = parseFloat(order.cod_received || 0);
                    const charge = parseFloat(order.courier_delivery_charge || 0);
                    const codFee = cod * 0.01;
                    const netOrder = cod - charge - codFee;
                %>
                <tr class="hover:bg-gray-50 transition-colors group">
                    <td class="px-6 py-4">
                        <div class="text-sm font-bold text-gray-900">
                            <%= new Date(order.settled_at).toLocaleDateString('en-GB') %>
                        </div>
                        <div class="text-xs text-gray-400 font-mono mt-0.5">
                            <%= new Date(order.settled_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <a href="/admin/orders/web-orders?q=<%= order.order_number %>" class="text-sm font-bold text-blue-600 hover:underline font-mono">
                            <%= order.order_number %>
                        </a>
                        <div class="text-xs text-gray-500 mt-0.5"><%= order.guest_name %></div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex flex-col items-end gap-1">
                            <span class="text-[10px] text-gray-400">COD: <b class="text-green-600">+<%= cod %></b></span>
                            <span class="text-[10px] text-gray-400">Fee: <b class="text-red-600">-<%= charge %></b></span>
                            <span class="text-[10px] text-gray-400">1%: <b class="text-orange-600">-<%= codFee.toFixed(2) %></b></span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-sm font-bold text-gray-900 font-mono bg-gray-100 px-2 py-1 rounded">৳<%= netOrder.toFixed(2) %></span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 border border-green-200">
                            <span class="material-icons-outlined text-[14px]">check</span> Settled
                        </span>
                    </td>
                </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
</div>

<div id="batchModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeBatchModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-between items-center border-b border-gray-100">
                    <h3 class="text-lg font-bold leading-6 text-gray-900" id="modalTitle">Batch Details</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeBatchModal()">
                        <span class="material-icons-outlined">close</span>
                    </button>
                </div>

                <div class="px-4 py-5 sm:p-6">
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6" id="modalSummary">
                        </div>

                    <div class="border rounded-lg overflow-hidden max-h-60 overflow-y-auto mb-6">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Invoice</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Collected</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Delivery</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">COD 1%</th>
                                    <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Net</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="modalItemsTable">
                                </tbody>
                        </table>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col md:flex-row items-center justify-between gap-4">
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-blue-900">Receive Money</h4>
                            <p class="text-xs text-blue-700">Select where this payout was deposited.</p>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <select id="depositAccount" class="bg-white border border-blue-200 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="" disabled selected>Select Account (Bank/Bkash)</option>
                                <% accounts.forEach(acc => { %>
                                    <option value="<%= acc.id %>"><%= acc.bank_name %> - <%= acc.account_name %></option>
                                <% }); %>
                            </select>
                            <button id="btnConfirmReceive" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md whitespace-nowrap flex items-center gap-2">
                                <span class="material-icons-outlined text-[18px]">download</span>
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Initial Load
    document.addEventListener('DOMContentLoaded', loadPendingBatches);

    // 2. Load Pending Batches via AJAX
    async function loadPendingBatches() {
        const container = document.getElementById('pendingContainer');
        container.innerHTML = `<div class="col-span-full py-8 text-center text-gray-400 bg-gray-50 rounded-xl animate-pulse">Loading payouts...</div>`;

        try {
            const res = await fetch('/admin/accounts/settlements/pending'); // Ensure this route matches
            const data = await res.json();

            if(data.success && data.batches.length > 0) {
                container.innerHTML = '';
                data.batches.forEach(batch => {
                    // Create Card HTML
                    const html = `
                        <div class="bg-white p-5 rounded-xl border-l-4 border-yellow-400 shadow-sm hover:shadow-md transition-all group relative overflow-hidden">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="text-xs font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded">PENDING</span>
                                    <h4 class="text-lg font-bold text-gray-900 mt-2">Batch #${batch.id}</h4>
                                    <p class="text-xs text-gray-500">${new Date(batch.created_at).toLocaleDateString()}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-400">Total COD</p>
                                    <p class="text-xl font-bold text-gray-900">৳${parseFloat(batch.cod_amount).toLocaleString()}</p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-50">
                                <span class="text-xs text-gray-400 font-mono">Orders: ${batch.total_consignment || '?'}</span>
                                <button onclick="openBatchModal('${batch.id}')" class="text-sm font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                    View Details <span class="material-icons-outlined text-[16px]">arrow_forward</span>
                                </button>
                            </div>
                        </div>
                    `;
                    container.innerHTML += html;
                });
            } else {
                container.innerHTML = `
                    <div class="col-span-full py-8 text-center bg-white rounded-xl border border-gray-100">
                        <span class="material-icons-outlined text-4xl text-green-200 mb-2">check_circle</span>
                        <p class="text-gray-500 font-medium">All caught up!</p>
                        <p class="text-xs text-gray-400">No pending payouts found.</p>
                    </div>
                `;
            }
        } catch (e) {
            console.error(e);
            container.innerHTML = `<div class="col-span-full text-red-500 text-center py-4">Failed to load batches.</div>`;
        }
    }

    // 3. Open Modal & Load Details
    async function openBatchModal(batchId) {
        document.getElementById('batchModal').classList.remove('hidden');
        document.getElementById('modalTitle').innerText = `Review Batch #${batchId}`;
        document.getElementById('btnConfirmReceive').setAttribute('onclick', `processBatch('${batchId}')`);
        
        const tbody = document.getElementById('modalItemsTable');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Loading details...</td></tr>';

        try {
            const res = await fetch(`/admin/accounts/settlements/batch/${batchId}`);
            const data = await res.json();

            if(data.success) {
                tbody.innerHTML = '';
                
                // The Controller now calculates everything perfectly for us
                const s = data.summary;

                data.items.forEach(item => {
                    // Recalculate net for display just to be safe, or use controller data
                    const net = item.cod_amount - item.delivery_charge - item.cod_charge;

                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 text-xs font-mono font-medium text-gray-900">${item.invoice}</td>
                            <td class="px-4 py-2 text-xs text-right text-green-600 font-bold">+${item.cod_amount.toLocaleString()}</td>
                            <td class="px-4 py-2 text-xs text-right text-red-600">-${item.delivery_charge}</td>
                            <td class="px-4 py-2 text-xs text-right text-orange-600">-${item.cod_charge.toFixed(2)}</td>
                            <td class="px-4 py-2 text-xs text-right font-bold text-gray-900">৳${net.toFixed(2)}</td>
                        </tr>
                    `;
                });

                // Update Summary Stats (The 5 Cards you asked for)
                document.getElementById('modalSummary').innerHTML = `
                    <div class="bg-gray-50 p-2 rounded text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Orders</p>
                        <p class="text-base font-bold text-gray-800">${s.total_orders}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Gross COD</p>
                        <p class="text-base font-bold text-gray-800">৳${s.total_cod.toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Total Delivery</p>
                        <p class="text-base font-bold text-red-600">-৳${s.total_delivery.toLocaleString()}</p>
                    </div>
                    <div class="bg-gray-50 p-2 rounded text-center">
                        <p class="text-[10px] text-gray-400 uppercase font-bold">Total COD 1%</p>
                        <p class="text-base font-bold text-orange-600">-৳${s.total_fee.toLocaleString()}</p>
                    </div>
                    <div class="bg-blue-50 p-2 rounded text-center border border-blue-100">
                        <p class="text-[10px] text-blue-600 font-bold uppercase">Net Payout</p>
                        <p class="text-xl font-bold text-blue-700">৳${s.net_payout.toLocaleString()}</p>
                    </div>
                `;
            }
        } catch(e) {
            alert("Error loading details: " + e.message);
        }
    }

    function closeBatchModal() {
        document.getElementById('batchModal').classList.add('hidden');
    }

    // 4. Submit Process
    async function processBatch(batchId) {
        const accountId = document.getElementById('depositAccount').value;
        const btn = document.getElementById('btnConfirmReceive');

        if(!accountId) {
            alert("Please select the Bank/Bkash account where you received this money.");
            return;
        }

        if(!confirm("Are you sure? This will add the net amount to your selected account.")) return;

        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons-outlined animate-spin text-[18px]">sync</span> Processing...';

        try {
            const res = await fetch('/admin/accounts/settlements/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>' // Ensure this variable exists in render
                },
                body: JSON.stringify({ batch_id: batchId, target_account_id: accountId })
            });

            const data = await res.json();

            if(data.success) {
                alert("Success! Money Received.");
                closeBatchModal();
                loadPendingBatches(); // Refresh Cards
                window.location.reload(); // Refresh History Table
            } else {
                alert("Error: " + data.message);
                btn.disabled = false;
                btn.innerText = 'Confirm';
            }
        } catch(e) {
            console.error(e);
            alert("System Error.");
            btn.disabled = false;
        }
    }
</script>