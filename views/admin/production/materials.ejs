<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Raw Materials Inventory</h1>
    <button onclick="document.getElementById('addMaterialModal').classList.remove('hidden')" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800 flex items-center gap-2">
        <span class="material-icons-outlined">add</span> Add Material
    </button>
</div>

<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <table class="w-full text-left border-collapse">
        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-bold">
            <tr>
                <th class="px-6 py-4">Material Name</th>
                <th class="px-6 py-4">Stock Level</th>
                <th class="px-6 py-4">Avg Cost (FIFO)</th>
                <th class="px-6 py-4">Total Value</th>
                <th class="px-6 py-4 text-right">Actions</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
            <% materials.forEach(m => { 
                const stock = parseFloat(m.stock_quantity);
                const cost = parseFloat(m.average_cost);
            %>
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 font-medium text-gray-900">
                    <%= m.name %>
                    <span class="block text-xs text-gray-400 font-normal"><%= m.unit %></span>
                </td>
                <td class="px-6 py-4">
                    <span class="font-mono font-bold <%= stock < m.alert_threshold ? 'text-red-600' : 'text-gray-700' %>">
                        <%= stock.toFixed(2) %> <%= m.unit %>
                    </span>
                </td>
                <td class="px-6 py-4 font-mono text-sm">৳<%= cost.toFixed(2) %></td>
                <td class="px-6 py-4 font-mono font-bold text-green-600">৳<%= (stock * cost).toFixed(2) %></td>
                <td class="px-6 py-4 text-right">
                    <button onclick="openStockModal('<%= m.id %>', '<%= m.name %>')" class="text-blue-600 hover:text-blue-800 text-sm font-bold bg-blue-50 px-3 py-1 rounded">
                        + Add Stock
                    </button>
                </td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<div id="addMaterialModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">Create Raw Material</h2>
        <form action="/admin/production/materials/add" method="POST">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Name</label>
                <input type="text" name="name" class="w-full border rounded p-2" required placeholder="e.g., White Cotton Fabric">
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Unit</label>
                    <input type="text" name="unit" class="w-full border rounded p-2" required placeholder="e.g., Yards">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Low Stock Alert</label>
                    <input type="number" name="alert_threshold" class="w-full border rounded p-2" value="10">
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="this.closest('#addMaterialModal').classList.add('hidden')" class="px-4 py-2 border rounded text-gray-600">Cancel</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create</button>
            </div>
        </form>
    </div>
</div>

<div id="stockModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 w-full max-w-md">
        <h2 class="text-xl font-bold mb-2">Purchase Stock</h2>
        <p class="text-sm text-gray-500 mb-4" id="stockModalTitle"></p>
        
        <form action="/admin/production/materials/stock" method="POST">
            <input type="hidden" name="id" id="stockId">
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Quantity Purchased</label>
                <input type="number" step="0.01" name="quantity" class="w-full border rounded p-2" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Total Bill Amount (BDT)</label>
                <input type="number" step="0.01" name="total_cost" class="w-full border rounded p-2" required>
                <p class="text-xs text-gray-400 mt-1">This updates the Average Cost automatically.</p>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" onclick="document.getElementById('stockModal').classList.add('hidden')" class="px-4 py-2 border rounded text-gray-600">Cancel</button>
                <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Confirm Purchase</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openStockModal(id, name) {
        document.getElementById('stockId').value = id;
        document.getElementById('stockModalTitle').innerText = 'Adding stock for: ' + name;
        document.getElementById('stockModal').classList.remove('hidden');
    }
</script>