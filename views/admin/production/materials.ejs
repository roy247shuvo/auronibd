<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Raw Materials</h1>
    <div class="flex gap-2">
        <button onclick="toggleModal('categoryModal')" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50">+ Category</button>
        <button onclick="toggleModal('materialModal')" class="bg-gray-900 text-white px-4 py-2 rounded-lg hover:bg-gray-800">+ New Material</button>
    </div>
</div>

<div class="space-y-6">
    <% categories.forEach(cat => { %>
        <% const catMats = materials.filter(m => m.category_id === cat.id); %>
        <% if(catMats.length > 0) { %>
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-6 py-3 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-gray-700 uppercase text-xs tracking-wider"><%= cat.name %></h3>
            </div>
            
            <div class="divide-y divide-gray-100">
                <% catMats.forEach(m => { %>
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h4 class="font-bold text-lg text-gray-900"><%= m.name %></h4>
                            <p class="text-xs text-gray-500"><%= m.description || 'No description' %> • Unit: <%= m.unit %></p>
                        </div>
                        <button onclick="openVariantModal('<%= m.id %>', '<%= m.name %>')" class="text-blue-600 text-xs font-bold hover:underline bg-blue-50 px-3 py-1.5 rounded">
                            + Add Variant (Color/Type)
                        </button>
                    </div>

                    <% if(m.variants && m.variants.length > 0) { %>
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="px-4 py-2 rounded-l-lg">Variant</th>
                                <th class="px-4 py-2">Stock</th>
                                <th class="px-4 py-2">Avg Cost</th>
                                <th class="px-4 py-2 text-right rounded-r-lg">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% m.variants.forEach(v => { %>
                            <tr class="border-b border-gray-50 last:border-0 hover:bg-gray-50">
                                <td class="px-4 py-3 font-medium text-gray-900"><%= v.name %></td>
                                <td class="px-4 py-3 font-mono <%= v.stock_quantity < v.alert_threshold ? 'text-red-600 font-bold' : 'text-gray-600' %>">
                                    <%= parseFloat(v.stock_quantity).toFixed(2) %> <%= m.unit %>
                                </td>
                                <td class="px-4 py-3 font-mono text-gray-500">৳<%= parseFloat(v.average_cost).toFixed(2) %></td>
                                <td class="px-4 py-3 text-right">
                                    <button onclick="openStockModal('<%= v.id %>', '<%= m.name %> - <%= v.name %>')" class="text-green-600 hover:text-green-800 font-bold text-xs">
                                        + Purchase Stock
                                    </button>
                                </td>
                            </tr>
                            <% }); %>
                        </tbody>
                    </table>
                    <% } else { %>
                        <p class="text-sm text-orange-500 italic bg-orange-50 p-2 rounded inline-block">No variants yet. Add 'Red', 'Blue' etc.</p>
                    <% } %>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>
    <% }); %>
</div>

<script>
function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
function openVariantModal(id, name) {
    document.getElementById('varMatId').value = id;
    document.getElementById('varModalTitle').innerText = 'Add Variant for ' + name;
    toggleModal('variantModal');
}
function openStockModal(id, name) {
    document.getElementById('stockVarId').value = id;
    document.getElementById('stockModalTitle').innerText = 'Purchase: ' + name;
    toggleModal('stockModal');
}
</script>