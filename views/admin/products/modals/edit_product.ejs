<% 
    const hasVariants = variants && variants.length > 0; 
    const lockClass = "bg-gray-100 text-gray-500 cursor-not-allowed";
%>

<% if (!can('prod_list', 'write')) { %>
<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
    <div class="flex">
        <div class="flex-shrink-0">
            <span class="material-icons-outlined text-yellow-400">lock</span>
        </div>
        <div class="ml-3">
            <p class="text-sm text-yellow-700">
                <span class="font-bold">View Only Mode:</span> You cannot update this product.
            </p>
        </div>
    </div>
</div>
<% } %>

<form id="editProductForm" action="/admin/products/update" method="POST" class="grid grid-cols-1 lg:grid-cols-3 gap-8 pb-10">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" name="id" value="<%= p.id %>">
    <input type="hidden" name="image_map_json" id="editImageMapInput">

    <div class="lg:col-span-2 space-y-6">
        
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">General Info</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Product Title</label>
                    <input type="text" name="name" value="<%= p.name %>" required 
                           class="w-full border border-gray-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                           <%= can('prod_list', 'write') ? '' : 'disabled' %>>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                    <textarea name="description" rows="3" 
                              class="w-full border border-gray-200 rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                              <%= can('prod_list', 'write') ? '' : 'disabled' %>><%= p.description %></textarea>
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
             <div class="flex justify-between items-center mb-4">
                 <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Pricing & SKU</h3>
                 <% if(hasVariants) { %>
                    <span id="priceLockMsg" class="text-[10px] text-red-500 font-bold flex items-center">
                        <span class="material-icons-outlined text-[12px] mr-1">lock</span>
                        Managed by Variants
                    </span>
                 <% } else { %>
                    <span id="priceLockMsg" class="text-[10px] text-gray-400 hidden">
                        <span class="material-icons-outlined text-[12px] mr-1">lock</span>
                        Managed by Variants
                    </span>
                 <% } %>
             </div>
             <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selling Price (MRP)</label>
                    <input type="number" name="compare_price" id="editMainCompare" value="<%= p.sale_price %>" 
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 <%= hasVariants ? lockClass : '' %> disabled:bg-gray-100 disabled:text-gray-500" 
                        <%= hasVariants ? 'readonly' : '' %>
                        <%= can('prod_list', 'write') ? '' : 'disabled' %>>
                </div>

                <div class="col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Discounted Price</label>
                    <input type="number" name="price" id="editMainPrice" value="<%= p.regular_price %>" 
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 <%= hasVariants ? lockClass : '' %> disabled:bg-gray-100 disabled:text-gray-500" 
                        <%= hasVariants ? 'readonly' : '' %>
                        <%= can('prod_list', 'write') ? '' : 'disabled' %>>
                </div>

                <div class="col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buying Price</label>
                    <input type="number" name="cost_price" id="editMainCost" value="<%= p.cost_price %>" 
                        class="w-full border border-gray-200 rounded-lg px-3 py-2 <%= hasVariants ? lockClass : 'bg-gray-50' %>" 
                        <%= hasVariants ? 'readonly' : '' %>>
                </div>
                <div class="col-span-2 lg:col-span-1">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">SKU (Locked)</label>
                    <input type="text" id="editMainSku" value="<%= p.sku %>" disabled class="w-full border border-gray-200 bg-gray-100 text-gray-500 cursor-not-allowed rounded-lg px-3 py-2 font-mono uppercase">
                </div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-sm font-bold text-gray-900">Variants</h3>
                <% if (can('prod_list', 'write')) { %>
                <button type="button" onclick="generateEditVariants()" class="bg-gray-900 text-white text-xs font-bold px-4 py-2 rounded-lg uppercase tracking-wide hover:bg-black transition shadow-lg">
                    Regenerate Table
                </button>
                <% } %>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="relative">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Colors</label>
                    <button type="button" onclick="toggleEditColorDropdown()" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm text-left flex justify-between items-center bg-white hover:border-gray-300">
                        <span class="text-gray-500">Add Color...</span>
                        <span class="material-icons-outlined text-gray-400 text-[18px]">expand_more</span>
                    </button>
                    <div id="editColorMenu" class="absolute z-20 w-full bottom-full mb-1 bg-white border border-gray-100 rounded-xl shadow-xl max-h-60 overflow-y-auto hidden custom-scrollbar">
                        <% allColors.forEach(c => { %> 
                            <div onclick="addEditColorTag('<%= c.name %>', '<%= c.shortcode %>', '<%= c.hex_code %>')" 
                                 class="flex items-center px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 transition group">
                                <div class="w-6 h-6 rounded-full border border-gray-200 shadow-sm mr-3" style="background-color: <%= c.hex_code %>;"></div>
                                <span class="text-sm text-gray-700 font-medium"><%= c.name %></span>
                            </div>
                        <% }) %>
                    </div>
                    <div id="editColorTags" class="flex flex-wrap gap-2 mt-3 min-h-[40px] p-2 bg-gray-50 rounded-lg border border-dashed border-gray-200 items-center"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Sizes</label>
                    <select id="editSizeDropdown" onchange="addEditTag('size')" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm bg-white">
                        <option value="">Add Size...</option>
                        <% if(typeof sizes !== 'undefined') { %>
                            <% sizes.forEach(s => { %> <option value="<%= s.name %>"><%= s.name %></option> <% }) %>
                        <% } %>
                    </select>
                    <div id="editSizeTags" class="flex flex-wrap gap-2 mt-3 min-h-[40px] p-2 bg-gray-50 rounded-lg border border-dashed border-gray-200"></div>
                </div>
            </div>

            <div id="editVariantTableContainer" class="overflow-x-auto border border-gray-200 rounded-lg">
                <table class="w-full text-xs text-left">
                    <thead class="bg-gray-50 text-gray-500 uppercase font-bold border-b border-gray-200">
                        <tr>
                            <th class="px-4 py-3">Variant</th>
                            <th class="px-4 py-3 w-24">Selling</th>
                            <th class="px-4 py-3 w-24">Discounted</th>
                            <th class="px-4 py-3 w-24">Buying</th>
                            <th class="px-4 py-3">SKU</th>
                            <th class="px-4 py-3 w-20">Qty</th>
                            <th class="px-4 py-3 w-10"></th>
                        </tr>
                    </thead>
                    <tbody id="editVariantTableBody" class="divide-y divide-gray-100 bg-white">
                        <% variants.forEach(v => { %>
                            <tr class="hover:bg-gray-50 group border-b border-gray-100 last:border-0">
                                <td class="px-4 py-3 font-medium text-gray-700">
                                    <%= v.color %> / <%= v.size %>
                                    <input type="hidden" name="variant_id[]" value="<%= v.id %>">
                                    <input type="hidden" name="variant_color[]" value="<%= v.color %>">
                                    <input type="hidden" name="variant_size[]" value="<%= v.size %>">
                                </td>
                                <td class="px-4 py-3"><input type="number" name="variant_price[]" value="<%= v.price %>" class="w-full border border-gray-200 rounded px-2 py-1 text-xs"></td>
                                <td class="px-4 py-3"><input type="number" name="variant_compare[]" value="<%= v.compare_price %>" class="w-full border border-gray-200 rounded px-2 py-1 text-xs"></td>
                                <td class="px-4 py-3"><input type="number" name="variant_cost[]" value="<%= v.cost_price %>" class="w-full border border-gray-200 rounded px-2 py-1 text-xs bg-gray-100 text-gray-500 cursor-not-allowed" readonly></td>
                                <td class="px-4 py-3"><input type="text" name="variant_sku[]" value="<%= v.sku %>" class="w-full border border-gray-200 rounded px-2 py-1 text-xs font-mono uppercase"></td>
                                <td class="px-4 py-3"><input type="number" name="variant_qty[]" value="<%= v.stock_quantity %>" class="w-full border border-gray-200 rounded px-2 py-1 text-xs font-bold text-center bg-gray-100 text-gray-500 cursor-not-allowed" readonly></td>
                                <td class="px-4 py-3 text-center">
                                    <button type="button" onclick="removeVariantRow(this)" class="text-gray-400 hover:text-red-500">
                                        <span class="material-icons-outlined text-base">delete</span>
                                    </button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h3 class="text-sm font-bold text-gray-900 mb-4">Product Images</h3>
            <div id="editImageManagerContainer" class="space-y-6"></div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 space-y-4">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Organization</h3>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Sales Channel</label>
                <select name="sales_channel" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="both" <%= p.sales_channel === 'both' ? 'selected' : '' %>>Both</option>
                    <option value="pos" <%= p.sales_channel === 'pos' ? 'selected' : '' %>>POS Only</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Brand</label>
                <select name="brand_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="">-- Select --</option>
                    <% brands.forEach(b => { %> <option value="<%= b.id %>" <%= p.brand_id === b.id ? 'selected' : '' %>><%= b.name %></option> <% }) %>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Category</label>
                <select name="category_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="">-- Select --</option>
                    <% categories.forEach(c => { %> <option value="<%= c.id %>" <%= p.category_id === c.id ? 'selected' : '' %>><%= c.name %></option> <% }) %>
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Type</label>
                <select name="type_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="">-- Select --</option>
                    <% types.forEach(t => { %> <option value="<%= t.id %>" <%= p.type_id === t.id ? 'selected' : '' %>><%= t.name %></option> <% }) %>
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Work Type</label>
                <select name="work_type_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="">-- Select --</option>
                    <% if(typeof work_types !== 'undefined') { %>
                        <% work_types.forEach(wt => { %> <option value="<%= wt.id %>" <%= p.work_type_id === wt.id ? 'selected' : '' %>><%= wt.name %></option> <% }) %>
                    <% } %>
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Fabric</label>
                <select name="fabric_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm">
                    <option value="">-- Select --</option>
                    <% if(typeof fabrics !== 'undefined') { %>
                        <% fabrics.forEach(f => { %> <option value="<%= f.id %>" <%= p.fabric_id === f.id ? 'selected' : '' %>><%= f.name %></option> <% }) %>
                    <% } %>
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Collection</label>
                <select name="collection_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm disabled:bg-gray-100 disabled:text-gray-500" <%= can('prod_list', 'write') ? '' : 'disabled' %>>
                     <% collections.forEach(col => { %> 
                        <option value="<%= col.id %>" <%= p.collection_id === col.id ? 'selected' : '' %>><%= col.name %></option> 
                     <% }) %>
                </select>
            </div>

            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Special Feature</label>
                <select name="special_feature_id" class="w-full border border-gray-200 rounded-lg px-3 py-2 text-sm" <%= can('prod_list', 'write') ? '' : 'disabled' %>>
                    <option value="">-- None --</option>
                    <% if(typeof specials !== 'undefined') { %>
                        <% specials.forEach(s => { %> 
                            <option value="<%= s.id %>" <%= p.special_feature_id === s.id ? 'selected' : '' %>><%= s.name %></option> 
                        <% }) %>
                    <% } %>
                </select>
            </div>
        </div>

        <% if (can('prod_list', 'write')) { %>
        <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-xl hover:bg-red-700 transition shadow-lg">
            Update Product
        </button>
        <% } %>
    </div>
</form>

<script>
    // === INITIALIZATION ===
    // Update global map with edit data
    imageMap = <%- JSON.stringify(imageMap) %>; 
    
    window.selectedColors = <%- JSON.stringify(selectedColors) %>;
    window.selectedSizes = <%- JSON.stringify(selectedSizes) %>;
    const existingVariants = <%- JSON.stringify(variants) %>;
    const lockClass = "bg-gray-100 text-gray-500 cursor-not-allowed";

    // === OVERRIDE RENDER FUNCTION FOR EDIT MODAL ===
    // This allows the global "renderImageSections" calls from removeImage/MediaModal 
    // to target the correct container in the Edit Modal.
    window.renderImageSections = function() {
        // Try to find the EDIT container first
        let container = document.getElementById('editImageManagerContainer');
        
        // If not found (Edit modal closed?), fall back to ADD container
        if (!container) container = document.getElementById('imageManagerContainer');
        
        if (!container) return; // Should not happen

        container.innerHTML = '';
        
        // Always render General first
        renderImageSection(container, 'General');

        // Then render each color
        window.selectedColors.forEach(c => {
            renderImageSection(container, c.value, c.hex);
        });
    }

    // Helper to render into a specific container
    function renderImageSection(container, colorName, hex = '#eee') {
        const slots = imageMap[colorName]; // Array [url, url, null]

        let html = `
        <div class="image-section border-t border-gray-100 pt-4 first:border-0 first:pt-0">
            <div class="flex items-center mb-3">
                ${colorName === 'General' ? 
                    '<span class="material-icons-outlined text-gray-400 mr-2 text-sm">collections</span>' : 
                    `<div class="w-4 h-4 rounded-full border border-gray-200 mr-2" style="background-color: ${hex}"></div>`
                }
                <h4 class="text-xs font-bold text-gray-600 uppercase">${colorName}</h4>
            </div>
            <div class="grid grid-cols-3 gap-3">
        `;

        slots.forEach((url, idx) => {
            if (url) {
                // FILLED SLOT
                html += `
                <div class="aspect-square rounded-lg border border-gray-200 relative overflow-hidden group bg-white">
                    <img src="${url}" class="w-full h-full object-cover">
                    <button type="button" onclick="removeImage('${colorName}', ${idx})" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-md z-10">
                        <span class="material-icons-outlined text-xs">close</span>
                    </button>
                </div>`;
            } else {
                // EMPTY SLOT
                html += `
                <div onclick="openMediaModal('${colorName}', ${idx})" class="aspect-square rounded-lg border-2 border-dashed border-gray-200 flex flex-col items-center justify-center text-gray-300 hover:border-gray-400 hover:text-gray-500 hover:bg-gray-50 transition cursor-pointer">
                    <span class="material-icons-outlined text-2xl mb-1">add</span>
                    <span class="text-[10px] font-bold">ADD</span>
                </div>`;
            }
        });

        html += `</div></div>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    // === EXECUTE INITIAL RENDER ===
    renderImageSections(); 
    
    // === REST OF EDIT LOGIC ===
    renderEditTags('color');
    renderEditTags('size');
    updateHiddenInput(); 

    function checkVariantLock() {
        const rows = document.querySelectorAll('#editVariantTableBody tr');
        const priceInputs = ['editMainPrice', 'editMainCompare', 'editMainCost'];
        const msg = document.getElementById('priceLockMsg');
        
        if(rows.length > 0) {
            priceInputs.forEach(id => {
                const el = document.getElementById(id);
                el.setAttribute('readonly', true);
                el.classList.add('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
            });
            msg.classList.remove('hidden');
        } else {
            priceInputs.forEach(id => {
                const el = document.getElementById(id);
                el.removeAttribute('readonly');
                el.classList.remove('bg-gray-100', 'text-gray-500', 'cursor-not-allowed');
                if(id === 'editMainCost') el.classList.add('bg-gray-50'); 
            });
            msg.classList.add('hidden');
        }
    }
    
    function removeVariantRow(btn) {
        btn.closest('tr').remove();
        checkVariantLock();
    }

    function toggleEditColorDropdown() { document.getElementById('editColorMenu').classList.toggle('hidden'); }
    
    function addEditColorTag(name, code, hex) {
        if (window.selectedColors.find(c => c.value === name)) { toggleEditColorDropdown(); return; }
        window.selectedColors.push({ value: name, code: code, hex: hex });
        if (!imageMap[name]) imageMap[name] = [null, null, null];
        toggleEditColorDropdown();
        renderEditTags('color');
        renderImageSections(); // Update images
        generateEditVariants(); // Update table
    }

    function addEditTag(type) {
        if (type === 'color') return;
        const dropdown = document.getElementById('editSizeDropdown');
        const value = dropdown.value;
        if (!value) return;
        if (window.selectedSizes.find(s => s.value === value)) return;
        window.selectedSizes.push({ value: value, code: '' });
        dropdown.value = "";
        renderEditTags('size');
        generateEditVariants(); 
    }

    function removeEditTag(type, index) {
        if (type === 'color') {
            const removed = window.selectedColors.splice(index, 1)[0];
            delete imageMap[removed.value];
            renderImageSections();
        }
        if (type === 'size') window.selectedSizes.splice(index, 1);
        renderEditTags(type);
        generateEditVariants(); 
    }

    function renderEditTags(type) {
        const container = document.getElementById(type === 'color' ? 'editColorTags' : 'editSizeTags');
        const list = type === 'color' ? window.selectedColors : window.selectedSizes;
        container.innerHTML = list.map((item, index) => {
            if (type === 'color') {
                return `<div class="relative group"><div class="w-8 h-8 rounded-full border border-gray-200 shadow-sm cursor-pointer" style="background-color: ${item.hex};"></div><button type="button" onclick="removeEditTag('color', ${index})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center opacity-0 group-hover:opacity-100"><span class="material-icons-outlined text-[10px]">close</span></button></div>`;
            } else {
                return `<div class="inline-flex items-center bg-white border border-gray-300 rounded px-2 py-1 shadow-sm text-xs font-medium text-gray-700">${item.value}<button type="button" onclick="removeEditTag('size', ${index})" class="ml-2 text-gray-400 hover:text-red-600"><span class="material-icons-outlined text-[14px]">close</span></button></div>`;
            }
        }).join('');
    }

    function generateEditVariants() {
        const tbody = document.getElementById('editVariantTableBody');
        const basePrice = document.getElementById('editMainPrice').value || 0;
        const comparePrice = document.getElementById('editMainCompare').value || 0;
        const costPrice = document.getElementById('editMainCost').value || 0;
        const mainSku = document.getElementById('editMainSku').value;

        tbody.innerHTML = '';
        if (window.selectedColors.length === 0 && window.selectedSizes.length === 0) {
            checkVariantLock(); 
            return;
        }

        const loopColors = window.selectedColors.length > 0 ? window.selectedColors : [{ value: '', code: '' }];
        const loopSizes = window.selectedSizes.length > 0 ? window.selectedSizes : [{ value: '', code: '' }];

        loopColors.forEach(color => {
            loopSizes.forEach(size => {
                const existing = existingVariants.find(v => 
                    (v.color === color.value || (v.color === 'N/A' && color.value === '')) && 
                    (v.size === size.value || (v.size === 'N/A' && size.value === ''))
                );

                const vId = existing ? existing.id : '';
                const vPrice = existing ? existing.price : basePrice;
                const vCompare = existing ? existing.compare_price : comparePrice;
                const vCost = existing ? existing.cost_price : costPrice;
                const vQty = existing ? existing.stock_quantity : 0;
                
                let vSku = existing ? existing.sku : '';
                if (!vSku) {
                    let suffix = '';
                    if(color.code) suffix += color.code;
                    let sizePart = size.value;
                    if(size.value && size.value.toLowerCase().includes('free')) sizePart = 'FR';
                    if(sizePart) suffix += sizePart;
                    vSku = suffix ? `${mainSku}-${suffix}` : mainSku;
                }

                let variantName = '';
                if(color.value && size.value) variantName = `${color.value} / ${size.value}`;
                else if(color.value) variantName = color.value;
                else if(size.value) variantName = size.value;

                const row = `
                <tr class="hover:bg-gray-50 group border-b border-gray-100 last:border-0">
                    <td class="px-4 py-3 font-medium text-gray-700">
                        ${variantName}
                        <input type="hidden" name="variant_id[]" value="${vId}">
                        <input type="hidden" name="variant_color[]" value="${color.value}">
                        <input type="hidden" name="variant_size[]" value="${size.value}">
                    </td>
                    <td class="px-4 py-3"><input type="number" name="variant_price[]" value="${vPrice}" class="w-full border border-gray-200 rounded px-2 py-1 text-xs"></td>
                    <td class="px-4 py-3"><input type="number" name="variant_compare[]" value="${vCompare}" class="w-full border border-gray-200 rounded px-2 py-1 text-xs"></td>
                    <td class="px-4 py-3"><input type="number" name="variant_cost[]" value="${vCost}" class="w-full border border-gray-200 rounded px-2 py-1 text-xs bg-gray-100 text-gray-500 cursor-not-allowed" readonly></td>
                    <td class="px-4 py-3"><input type="text" name="variant_sku[]" value="${vSku}" class="w-full border border-gray-200 rounded px-2 py-1 text-xs font-mono uppercase"></td>
                    <td class="px-4 py-3"><input type="number" name="variant_qty[]" value="${vQty}" class="w-full border border-gray-200 rounded px-2 py-1 text-xs font-bold text-center bg-gray-100 text-gray-500 cursor-not-allowed" readonly></td>
                    <td class="px-4 py-3 text-center">
                        <button type="button" onclick="removeVariantRow(this)" class="text-gray-400 hover:text-red-500">
                            <span class="material-icons-outlined text-base">delete</span>
                        </button>
                    </td>
                </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        });
        
        checkVariantLock();
    }
    
    function updateHiddenInput() {
        const cleanMap = {};
        for (const [key, val] of Object.entries(imageMap)) {
            const validUrls = val.filter(u => u !== null);
            if (validUrls.length > 0) cleanMap[key] = validUrls;
        }
        document.getElementById('editImageMapInput').value = JSON.stringify(cleanMap);
    }
</script>