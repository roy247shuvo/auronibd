<div id="materialPOModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" onclick="closeMaterialPO()"></div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
            
            <div class="bg-purple-900 px-4 py-3 sm:px-6 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-white flex items-center gap-2">
                    <span class="material-icons-outlined">texture</span>
                    Purchase Raw Materials
                </h3>
                <button type="button" class="text-purple-200 hover:text-white" onclick="closeMaterialPO()">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>

            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Vendor</label>
                        <select id="matVendorId" class="w-full border-gray-300 rounded-md shadow-sm p-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="">-- Choose Vendor --</option>
                            <% vendors.forEach(v => { %>
                                <option value="<%= v.id %>"><%= v.name %></option>
                            <% }); %>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Category</label>
                        <select id="matCategorySelect" onchange="loadMaterialsForPO(this.value)" class="w-full border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">-- Choose Category --</option>
                            <% categories.forEach(c => { %>
                                <option value="<%= c.id %>"><%= c.name %></option>
                            <% }); %>
                        </select>
                    </div>
                </div>

                <div class="border rounded-lg overflow-hidden mb-6">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-bold text-gray-500 uppercase">Material</th>
                                <th class="px-4 py-2 text-center text-xs font-bold text-gray-500 uppercase">Current Stock</th>
                                <th class="px-4 py-2 text-center text-xs font-bold text-gray-500 uppercase">Purchase Qty</th>
                                <th class="px-4 py-2 text-right text-xs font-bold text-gray-500 uppercase">Unit Cost</th>
                                <th class="px-4 py-2 text-right text-xs font-bold text-gray-500 uppercase">Total</th>
                                <th class="px-4 py-2"></th>
                            </tr>
                        </thead>
                        <tbody id="matPoItemsTable" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        <tfoot class="bg-gray-50">
                            <tr>
                                <td colspan="6" class="px-4 py-2">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
                                        <div class="md:col-span-5">
                                            <select id="matSelectName" class="w-full border-gray-300 rounded text-sm p-2" onchange="filterMatVariants()" disabled>
                                                <option value="">Select Category First</option>
                                            </select>
                                        </div>
                                        
                                        <div class="md:col-span-5">
                                            <select id="matSelectVariant" class="w-full border-gray-300 rounded text-sm p-2" disabled>
                                                <option value="">Select Variant...</option>
                                            </select>
                                        </div>

                                        <div class="md:col-span-2">
                                            <button type="button" onclick="addMatToTable()" class="w-full bg-purple-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-purple-700 flex items-center justify-center gap-1">
                                                <span class="material-icons-outlined text-sm">add</span> Add
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="flex flex-col md:flex-row justify-end gap-8 border-t pt-4">
                    <div class="w-full md:w-1/3 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Subtotal:</span>
                            <span class="font-bold" id="matPoTotal">TK. 0.00</span>
                        </div>
                        
                        <div class="bg-gray-50 p-3 rounded text-sm">
                            <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                <input type="checkbox" id="matMakePayment" onchange="toggleMatPayment()" class="rounded text-purple-600">
                                <span class="font-bold text-gray-700">Add Payment Now?</span>
                            </label>
                            <div id="matPaymentSection" class="hidden space-y-2">
                                <input type="number" id="matPayAmount" placeholder="Amount" class="w-full border rounded p-1">
                                <select id="matPayAccount" class="w-full border rounded p-1">
                                    <% accounts.forEach(acc => { %>
                                        <option value="<%= acc.id %>"><%= acc.bank_name %> - <%= acc.account_name %></option>
                                    <% }); %>
                                </select>
                            </div>
                        </div>

                        <button type="button" onclick="submitMaterialPO()" class="w-full bg-purple-900 text-white py-2 rounded-lg font-bold shadow hover:bg-purple-800">
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let rawMaterialsCache = [];
    let matPoItems = [];

    function openMaterialPOCreator() {
        document.getElementById('materialPOModal').classList.remove('hidden');
    }

    function closeMaterialPO() {
        document.getElementById('materialPOModal').classList.add('hidden');
        matPoItems = [];
        renderMatTable();
    }

    // 1. Fetch data when Category is selected
    async function loadMaterialsForPO(catId) {
        const matSelect = document.getElementById('matSelectName');
        const varSelect = document.getElementById('matSelectVariant');
        
        // Reset UI
        matSelect.innerHTML = '<option>Loading...</option>';
        matSelect.disabled = true;
        varSelect.innerHTML = '<option value="">Select Variant...</option>';
        varSelect.disabled = true;
        
        if(!catId) {
            matSelect.innerHTML = '<option value="">Select Category First</option>';
            return; 
        }

        try {
            // CALL THE API
            const res = await fetch(`/admin/purchase-orders/api/search-materials?category_id=${catId}`);
            if(!res.ok) throw new Error("Failed to load");
            
            rawMaterialsCache = await res.json();
            
            // Extract Unique Material Names
            const uniqueMats = [];
            const seen = new Set();
            
            rawMaterialsCache.forEach(item => {
                if(!seen.has(item.mat_id)) {
                    seen.add(item.mat_id);
                    uniqueMats.push({ id: item.mat_id, name: item.mat_name });
                }
            });

            // Populate Name Dropdown
            matSelect.innerHTML = '<option value="">-- Select Material --</option>';
            uniqueMats.forEach(m => {
                matSelect.innerHTML += `<option value="${m.id}">${m.name}</option>`;
            });
            matSelect.disabled = false;

        } catch(e) { 
            console.error(e); 
            matSelect.innerHTML = '<option>Error loading products</option>'; 
        }
    }

    // 2. Filter Variants when Material Name is selected
    function filterMatVariants() {
        const matId = document.getElementById('matSelectName').value;
        const varSelect = document.getElementById('matSelectVariant');
        
        varSelect.innerHTML = '<option value="">-- Select Variant --</option>';
        varSelect.disabled = true;

        if(!matId) return;

        // Filter the cache
        const variants = rawMaterialsCache.filter(m => m.mat_id == matId);
        
        variants.forEach(v => {
            varSelect.innerHTML += `<option value="${v.var_id}">${v.var_name} (Stock: ${v.stock_quantity} ${v.unit})</option>`;
        });
        varSelect.disabled = false;
    }

    // 3. Add to Table
    function addMatToTable() {
        const varId = document.getElementById('matSelectVariant').value;
        if(!varId) { alert("Please select a variant."); return; }

        const item = rawMaterialsCache.find(m => m.var_id == varId);
        if(!item) return;

        if(matPoItems.find(i => i.id == varId)) { alert('Item already added'); return; }

        matPoItems.push({
            id: item.var_id, 
            name: `${item.mat_name} - ${item.var_name}`,
            unit: item.unit,
            stock: item.stock_quantity,
            qty: 1,
            cost: 0
        });
        renderMatTable();
    }

    function renderMatTable() {
        const tbody = document.getElementById('matPoItemsTable');
        tbody.innerHTML = '';
        let total = 0;

        matPoItems.forEach((item, index) => {
            const lineTotal = item.qty * item.cost;
            total += lineTotal;

            tbody.innerHTML += `
                <tr>
                    <td class="px-4 py-2 text-sm text-gray-900">${item.name}</td>
                    <td class="px-4 py-2 text-center text-sm text-gray-500">${item.stock} ${item.unit}</td>
                    <td class="px-4 py-2 text-center">
                        <input type="number" step="0.01" value="${item.qty}" 
                            class="w-20 border rounded p-1 text-center"
                            onchange="updateMatItem(${index}, 'qty', this.value)">
                    </td>
                    <td class="px-4 py-2 text-right">
                        <input type="number" step="0.01" value="${item.cost}" 
                            class="w-24 border rounded p-1 text-right"
                            onchange="updateMatItem(${index}, 'cost', this.value)">
                    </td>
                    <td class="px-4 py-2 text-right font-bold text-gray-700">
                        TK. ${lineTotal.toFixed(2)}
                    </td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="removeMatItem(${index})" class="text-red-500"><span class="material-icons-outlined text-sm">delete</span></button>
                    </td>
                </tr>
            `;
        });

        document.getElementById('matPoTotal').innerText = 'TK. ' + total.toFixed(2);
    }

    function updateMatItem(index, field, val) {
        matPoItems[index][field] = parseFloat(val) || 0;
        renderMatTable();
    }

    function removeMatItem(index) {
        matPoItems.splice(index, 1);
        renderMatTable();
    }

    function toggleMatPayment() {
        document.getElementById('matPaymentSection').classList.toggle('hidden');
    }

    async function submitMaterialPO() {
        const vendorId = document.getElementById('matVendorId').value;
        if(!vendorId) return alert('Please select a vendor');
        if(matPoItems.length === 0) return alert('Add at least one material');

        const payload = {
            type: 'material',
            vendor_id: vendorId,
            items: matPoItems,
            payment: null
        };

        if(document.getElementById('matMakePayment').checked) {
            payload.payment = {
                amount: document.getElementById('matPayAmount').value,
                accountId: document.getElementById('matPayAccount').value,
                date: new Date().toISOString().split('T')[0]
            };
        }

        try {
            const res = await fetch('/admin/purchase-orders/create', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>'
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.success) location.reload();
            else alert(data.error);
        } catch(e) {
            console.error(e);
            alert('System Error');
        }
    }
</script>