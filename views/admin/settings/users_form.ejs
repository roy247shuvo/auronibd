<div class="p-6 max-w-5xl mx-auto">
    <% if (!can('user_roles', 'write')) { %>
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-r shadow-sm">
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="material-icons-outlined text-yellow-400">lock</span>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    <span class="font-bold">View Only Mode:</span> You do not have permission to manage users.
                </p>
            </div>
        </div>
    </div>
    <% } %>

    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
            <a href="/admin/settings/users" class="bg-white p-2 rounded-full border border-gray-200 hover:bg-gray-50 text-gray-500">
                <span class="material-icons-outlined text-sm">arrow_back</span>
            </a>
            <h2 class="text-2xl font-bold text-gray-800"><%= user ? 'Edit User' : 'Add New User' %></h2>
        </div>
    </div>

    <form action="/admin/settings/users/save" method="POST">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="user_id" value="<%= user ? user.id : '' %>">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 pb-2 border-b">Account Info</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" name="full_name" value="<%= user ? user.name : '' %>" required 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" name="email" value="<%= user ? user.email : '' %>" required 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="text" name="phone" value="<%= user ? user.phone : '' %>" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" name="password" placeholder="<%= user ? 'Leave empty to keep current' : 'Enter password' %>" 
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-red-500 outline-none disabled:bg-gray-100 disabled:text-gray-500"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4 pb-2 border-b">Role</h3>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="role" value="user" onchange="handleRoleChange(this.value)" 
                                   <%= (!user || user.role === 'user') ? 'checked' : '' %> 
                                   class="text-red-600 focus:ring-red-500 disabled:text-gray-400"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                            <div>
                                <div class="font-medium text-gray-900">User / Staff</div>
                                <div class="text-xs text-gray-500">Restricted permissions</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="role" value="owner" onchange="handleRoleChange(this.value)" 
                                   <%= (user && user.role === 'owner') ? 'checked' : '' %> 
                                   class="text-blue-600 focus:ring-blue-500 disabled:text-gray-400"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                            <div>
                                <div class="font-medium text-gray-900">Owner</div>
                                <div class="text-xs text-gray-500">Full Access (Configurable)</div>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                            <input type="radio" name="role" value="admin" onchange="handleRoleChange(this.value)" 
                                   <%= (user && user.role === 'admin') ? 'checked' : '' %> 
                                   class="text-purple-600 focus:ring-purple-500 disabled:text-gray-400"
                                   <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                            <div>
                                <div class="font-medium text-gray-900">Super Admin</div>
                                <div class="text-xs text-gray-500">Cannot be restricted</div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <% if (can('user_roles', 'write')) { %>
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 shadow-lg shadow-red-200">
                    Save User
                </button>
                <% } %>
            </div>

            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden" id="permissionContainer">
                    <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                        <h3 class="font-bold text-gray-800">Module Permissions</h3>
                        <div class="text-xs text-gray-500 bg-white px-2 py-1 rounded border">
                            <span class="text-red-600 font-bold">None</span> / 
                            <span class="text-yellow-600 font-bold">View</span> / 
                            <span class="text-green-600 font-bold">Full</span>
                        </div>
                    </div>
                    
                    <div class="p-6 space-y-8">
                        <% for (const [groupKey, group] of Object.entries(modules)) { %>
                            <div class="permission-group">
                                <h4 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
                                    <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                    <%= group.label %>
                                </h4>
                                <div class="grid grid-cols-1 gap-4 pl-4 border-l-2 border-gray-100">
                                    <% for (const [itemKey, itemLabel] of Object.entries(group.items)) { 
                                        let currentPerm = 'none';
                                        if (user && user.permissions && user.permissions[itemKey]) {
                                            currentPerm = user.permissions[itemKey];
                                        }
                                    %>
                                    <div class="flex items-center justify-between group hover:bg-gray-50 p-2 rounded">
                                        <span class="text-sm text-gray-600 font-medium"><%= itemLabel %></span>
                                        <div class="flex items-center gap-1 bg-white border rounded p-1">
                                            <label class="cursor-pointer px-3 py-1 rounded text-xs transition-colors <%= currentPerm === 'none' ? 'bg-red-100 text-red-700 font-bold' : 'text-gray-400 hover:bg-gray-100' %>">
                                                <input type="radio" name="perms[<%= itemKey %>]" value="none" 
                                                       class="hidden perm-radio" 
                                                       <%= currentPerm === 'none' ? 'checked' : '' %>
                                                       <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                                                None
                                            </label>
                                            <label class="cursor-pointer px-3 py-1 rounded text-xs transition-colors <%= currentPerm === 'read' ? 'bg-yellow-100 text-yellow-700 font-bold' : 'text-gray-400 hover:bg-gray-100' %>">
                                                <input type="radio" name="perms[<%= itemKey %>]" value="read" 
                                                       class="hidden perm-radio" 
                                                       <%= currentPerm === 'read' ? 'checked' : '' %>
                                                       <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                                                View
                                            </label>
                                            <label class="cursor-pointer px-3 py-1 rounded text-xs transition-colors <%= currentPerm === 'write' ? 'bg-green-100 text-green-700 font-bold' : 'text-gray-400 hover:bg-gray-100' %>">
                                                <input type="radio" name="perms[<%= itemKey %>]" value="write" 
                                                       class="hidden perm-radio" 
                                                       <%= currentPerm === 'write' ? 'checked' : '' %>
                                                       <%= can('user_roles', 'write') ? '' : 'disabled' %>>
                                                Full
                                            </label>
                                        </div>
                                    </div>
                                    <% } %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div id="adminOverlay" class="hidden bg-purple-50 border border-purple-200 rounded-xl p-8 text-center mt-6">
                    <span class="material-icons-outlined text-4xl text-purple-400 mb-2">verified_user</span>
                    <h3 class="text-lg font-bold text-purple-900">Super Admin Access</h3>
                    <p class="text-purple-600">This user has full access to the entire system. Permissions cannot be restricted.</p>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    // 1. UI Logic for Radio Buttons (Visual Highlight)
    document.querySelectorAll('.perm-radio').forEach(radio => {
        radio.addEventListener('change', function() {
            // Reset siblings
            const container = this.closest('div');
            container.querySelectorAll('label').forEach(lbl => {
                lbl.className = 'cursor-pointer px-3 py-1 rounded text-xs transition-colors text-gray-400 hover:bg-gray-100';
            });
            
            // Highlight selected
            const label = this.closest('label');
            if (this.value === 'none') label.className = 'cursor-pointer px-3 py-1 rounded text-xs transition-colors bg-red-100 text-red-700 font-bold';
            if (this.value === 'read') label.className = 'cursor-pointer px-3 py-1 rounded text-xs transition-colors bg-yellow-100 text-yellow-700 font-bold';
            if (this.value === 'write') label.className = 'cursor-pointer px-3 py-1 rounded text-xs transition-colors bg-green-100 text-green-700 font-bold';
        });
    });

    // 2. Role Handling (Admin Hide / Owner Default)
    function handleRoleChange(role) {
        const container = document.getElementById('permissionContainer');
        const overlay = document.getElementById('adminOverlay');

        if (role === 'admin') {
            container.classList.add('hidden');
            overlay.classList.remove('hidden');
        } else {
            container.classList.remove('hidden');
            overlay.classList.add('hidden');
            
            // If Owner is selected, default EVERYTHING to Write (if adding new user)
            // Or if user explicitly wants to reset owner defaults
            if (role === 'owner') {
                 // Optional: Ask user or just do it? 
                 // For now, let's just pre-fill visual styles if they click Owner
                 // But we won't force-overwrite existing choices to avoid data loss on edit
                 // UNLESS it's a new user (no ID)
                 const isEdit = document.querySelector('input[name="user_id"]').value !== '';
                 if (!isEdit) {
                     document.querySelectorAll('input[value="write"]').forEach(r => {
                         r.checked = true;
                         r.dispatchEvent(new Event('change')); // Trigger visual update
                     });
                 }
            }
        }
    }
    
    // Run on load to set initial state
    const currentRole = document.querySelector('input[name="role"]:checked').value;
    handleRoleChange(currentRole);
</script>