
<div class="p-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">Gift Hunt Campaign</h1>
            <p class="text-sm text-gray-500">Manage participants and campaigns</p>
        </div>
        
        <form action="/admin/gamification/status" method="POST" class="flex items-center gap-3 bg-white p-2 rounded shadow">
            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
            
            <span class="text-sm font-bold <%= isActive ? 'text-green-600' : 'text-gray-400' %>">
                <%= isActive ? 'CAMPAIGN ON' : 'CAMPAIGN OFF' %>
            </span>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" name="is_active" class="sr-only peer" onchange="this.form.submit()" <%= isActive ? 'checked' : '' %>>
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
            </label>
        </form>
    </div>

    <% if (activeCampaign) { %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex justify-between items-center">
            <div>
                <h3 class="font-bold text-blue-900">Current Campaign #<%= activeCampaign.id %></h3>
                <p class="text-sm text-blue-700">Started: <%= new Date(activeCampaign.start_date).toDateString() %></p>
                <p class="text-sm text-blue-700">Total Participants: <strong><%= currentParticipants.length %></strong></p>
            </div>
            
            <% if (isActive && currentParticipants.length > 0) { %>
                <button onclick="startLotteryAnimation()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded shadow-lg font-bold flex items-center gap-2 transition-transform active:scale-95">
                    <span class="material-icons-outlined">emoji_events</span> Draw Winner Now
                </button>
            <% } else if (isActive) { %>
                <button disabled class="bg-gray-300 text-gray-500 px-6 py-2 rounded font-bold cursor-not-allowed">
                    Waiting for Participants...
                </button>
            <% } %>
        </div>
    <% } %>

    <div x-data="{ tab: 'current' }">
        <div class="flex border-b border-gray-200 mb-4">
            <button @click="tab = 'current'" :class="{ 'border-black text-black': tab === 'current', 'border-transparent text-gray-500': tab !== 'current' }" class="pb-2 px-4 border-b-2 font-medium transition">
                Current Participants
            </button>
            <button @click="tab = 'history'" :class="{ 'border-black text-black': tab === 'history', 'border-transparent text-gray-500': tab !== 'history' }" class="pb-2 px-4 border-b-2 font-medium transition">
                History & Winners
            </button>
        </div>

        <div x-show="tab === 'current'" class="bg-white rounded shadow overflow-hidden">
            <% if (currentParticipants.length === 0) { %>
                <div class="p-8 text-center text-gray-400">
                    No participants in the current campaign yet.
                </div>
            <% } else { %>
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-xs uppercase text-gray-600 border-b">
                            <th class="p-3">Date</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Phone</th>
                            <th class="p-3">Code</th>
                        </tr>
                    </thead>
                    <tbody class="text-sm">
                        <% currentParticipants.forEach(p => { %>
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3"><%= new Date(p.created_at).toLocaleString() %></td>
                            <td class="p-3 font-medium"><%= p.name %></td>
                            <td class="p-3"><%= p.phone %></td>
                            <td class="p-3 font-mono text-blue-600"><%= p.code %></td>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            <% } %>
        </div>

        <div x-show="tab === 'history'" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <% if (history.length === 0) { %>
                <div class="col-span-3 text-center p-8 text-gray-400">No previous campaigns found.</div>
            <% } %>

            <% history.forEach(camp => { %>
                <div onclick="openHistoryModal(<%= camp.id %>)" class="bg-white p-4 rounded-lg shadow border border-gray-100 cursor-pointer hover:shadow-md transition group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">CAMPAIGN #<%= camp.id %></span>
                        <span class="text-xs text-gray-400"><%= new Date(camp.end_date).toLocaleDateString() %></span>
                    </div>
                    
                    <div class="mb-4">
                        <p class="text-sm text-gray-500">Total Participants</p>
                        <p class="text-2xl font-bold"><%= camp.total_participants %></p>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="material-icons-outlined text-yellow-600 text-sm">emoji_events</span>
                            <span class="text-xs font-bold text-yellow-800 uppercase">Winner</span>
                        </div>
                        <p class="font-bold text-gray-800"><%= camp.winner_name || 'N/A' %></p>
                        <p class="text-xs text-gray-600 mb-1"><%= camp.winner_phone %></p>
                        <div class="text-xs font-mono bg-white border border-yellow-300 text-yellow-800 px-2 py-0.5 rounded inline-block">
                            üé´ Code: <strong><%= camp.winner_code || 'N/A' %></strong>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-center text-xs text-blue-600 opacity-0 group-hover:opacity-100 transition">
                        Click to view all participants
                    </div>
                </div>
            <% }) %>
        </div>
    </div>
</div>

<div id="historyModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-2xl rounded-lg shadow-2xl h-[80vh] flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h3 class="font-bold text-lg">Campaign Details</h3>
            <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-gray-400 hover:text-black">
                <span class="material-icons-outlined">close</span>
            </button>
        </div>
        
        <div class="flex-1 overflow-auto p-0">
            <table class="w-full text-left">
                <thead class="bg-gray-100 text-xs uppercase text-gray-600 sticky top-0">
                    <tr>
                        <th class="p-3">Status</th>
                        <th class="p-3">Name</th>
                        <th class="p-3">Phone</th>
                        <th class="p-3">Code</th>
                    </tr>
                </thead>
                <tbody id="modalBody" class="text-sm">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="lotteryModal" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center">
    <div class="text-center w-full max-w-2xl px-4">
        
        <div id="animationStage">
            <h2 class="text-white text-2xl mb-8 font-light tracking-[0.2em] uppercase">Selecting Winner...</h2>
            <div id="rollingNumbers" class="text-9xl font-mono font-bold text-yellow-400 tabular-nums animate-pulse">
                0000
            </div>
        </div>

        <div id="winnerStage" class="hidden transform transition-all duration-700 scale-0">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-white text-xl mb-2 font-light uppercase tracking-widest">Congratulations!</h2>
            
            <div class="text-7xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 via-yellow-100 to-yellow-300 drop-shadow-[0_0_25px_rgba(234,179,8,0.5)] mb-4 animate-bounce-custom">
                <span id="winnerText"></span>
            </div>
            
            <p class="text-gray-400 text-lg mb-8">Ticket Code: <span id="winnerCode" class="font-mono text-yellow-500"></span></p>

            <button onclick="window.location.reload()" class="bg-white text-black px-8 py-3 rounded-full font-bold hover:bg-yellow-400 transition shadow-[0_0_20px_rgba(255,255,255,0.3)]">
                Close & View Results
            </button>
        </div>

    </div>
</div>

<style>
    @keyframes boom-enter {
        0% { opacity: 0; transform: scale(0.5) rotate(-5deg); }
        50% { transform: scale(1.2) rotate(3deg); }
        70% { transform: scale(0.9) rotate(-2deg); }
        100% { opacity: 1; transform: scale(1) rotate(0); }
    }
    .animate-boom {
        animation: boom-enter 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
    }
</style>

<script>
    // ‡¶ï‡¶®‡¶´‡ßá‡¶ü‡¶ø ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ (‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
    if (typeof confetti === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
        document.head.appendChild(script);
    }

    // [NEW] History Modal Function (Added Here)
    window.openHistoryModal = async function(campaignId) {
        const modal = document.getElementById('historyModal');
        const tbody = document.getElementById('modalBody');
        
        if (!modal) return;
        
        // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ü‡ßá‡¶ü
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Loading data...</td></tr>';
        modal.classList.remove('hidden');

        try {
            const res = await fetch(`/api/gamification/history/${campaignId}`);
            const data = await res.json();
            
            tbody.innerHTML = '';
            
            if (data.participants && data.participants.length > 0) {
                data.participants.forEach(p => {
                    const isWinner = p.is_winner == 1;
                    const rowClass = isWinner ? 'bg-yellow-50 border-l-4 border-yellow-400' : 'border-b hover:bg-gray-50';
                    
                    const row = `
                        <tr class="${rowClass}">
                            <td class="p-3">
                                ${isWinner ? '<span class="text-yellow-600 font-bold flex items-center gap-1"><span class="material-icons-outlined text-sm">emoji_events</span> WINNER</span>' : '<span class="text-gray-400">Participant</span>'}
                            </td>
                            <td class="p-3 font-medium ${isWinner ? 'text-black' : 'text-gray-700'}">${p.name}</td>
                            <td class="p-3 text-gray-600">${p.phone}</td>
                            <td class="p-3 font-mono text-xs">${p.code}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-400">No participants found.</td></tr>';
            }

        } catch (error) {
            console.error(error);
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-red-500">Failed to load data</td></tr>';
        }
    }

    async function startLotteryAnimation() {
        if (!confirm('Are you sure? This will select a winner and END the current campaign.')) return;

        const modal = document.getElementById('lotteryModal');
        const rollingEl = document.getElementById('rollingNumbers');
        const animStage = document.getElementById('animationStage');
        const winStage = document.getElementById('winnerStage');
        const winnerText = document.getElementById('winnerText');
        const winnerCode = document.getElementById('winnerCode');

        // ‡ßß. ‡¶Æ‡¶°‡¶æ‡¶≤ ‡¶ì‡¶™‡ßá‡¶®
        modal.classList.remove('hidden');
        animStage.classList.remove('hidden');
        winStage.classList.add('hidden');
        winStage.classList.remove('animate-boom'); // ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü

        // ‡ß®. ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶∞‡ßã‡¶≤‡¶ø‡¶Ç ‡¶∂‡ßÅ‡¶∞‡ßÅ
        let interval = setInterval(() => {
            rollingEl.innerText = Math.floor(1000 + Math.random() * 9000);
        }, 50);

        try {
            // ‡ß©. ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶è‡¶®‡ßç‡¶°‡ßá ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü (‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
            // CSRF ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≠‡ßá‡¶∞‡¶ø‡ßü‡ßá‡¶¨‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡¶ö‡ßç‡¶õ‡ßá EJS ‡¶•‡ßá‡¶ï‡ßá
            const res = await fetch('/admin/gamification/draw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'CSRF-Token': '<%= csrfToken %>' // [FIX] CSRF Error Solution
                }
            });
            const data = await res.json();

            if (data.success) {
                // ‡ß™. ‡¶°‡ßç‡¶∞ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶∞‡¶ì ‡ß® ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶∏‡¶æ‡¶∏‡¶™‡ßá‡¶®‡ßç‡¶∏ ‡¶∞‡¶æ‡¶ñ‡¶æ
                setTimeout(() => {
                    clearInterval(interval); // ‡¶∞‡ßã‡¶≤‡¶ø‡¶Ç ‡¶¨‡¶®‡ßç‡¶ß

                    // ‡ß´. ‡¶â‡¶á‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡ßá‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
                    animStage.classList.add('hidden');
                    winStage.classList.remove('hidden');
                    winStage.classList.remove('scale-0'); // Scale up
                    winStage.classList.add('animate-boom'); // Boom animation
                    
                    winnerText.innerText = data.winnerName;
                    winnerCode.innerText = data.winnerCode;

                    // ‡ß¨. ‡¶ï‡¶®‡¶´‡ßá‡¶ü‡¶ø ‡¶¨‡ßç‡¶≤‡¶æ‡¶∏‡ßç‡¶ü
                    if (typeof confetti !== 'undefined') {
                        var duration = 3 * 1000;
                        var end = Date.now() + duration;
                        (function frame() {
                            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                            if (Date.now() < end) requestAnimationFrame(frame);
                        }());
                    }

                }, 2000);
            } else {
                alert("Error: " + data.message);
                window.location.reload();
            }

        } catch (error) {
            console.error(error);
            alert("Something went wrong!");
            window.location.reload();
        }
    }
</script>